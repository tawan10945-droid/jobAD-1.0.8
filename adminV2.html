<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Dashboard ‡∏£‡∏∞‡∏ö‡∏ö AUTODIDACTIC (Admin)</title>

  <!-- FullCalendar -->
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>

  <style>
    :root {
      --red-600:#c72828;
      --red-700:#9b1f1f;
      --card-bg:#fff;
      --muted:#666;
    }

    * { box-sizing:border-box }

    body {
      font-family:'Prompt', sans-serif;
      margin:0; 
      padding:0;
      background:linear-gradient(to bottom,#fff,#fdeaea);
      color:#111;
    }

    /* ===== Header ===== */
    header {
      background:linear-gradient(90deg,#c00,#f44336);
      color:#fff;
      padding:12px 20px;
      display:flex; 
      justify-content:space-between; 
      align-items:center;
      flex-wrap:wrap;
      position:sticky; 
      top:0; 
      z-index:10;
      box-shadow:0 4px 6px rgba(0,0,0,0.1);
    }

    .logo-title { 
      display:flex; 
      gap:12px; 
      align-items:center; 
    }

    .logo-title img { 
      width:50px; 
      background:rgba(255,255,255,0.8); 
      padding:5px; 
      border-radius:8px; 
    }

    .nav-btn { 
      color:#fff; 
      background:rgba(0,0,0,0.2); 
      padding:8px 12px; 
      border-radius:8px; 
      text-decoration:none; 
      font-weight:700; 
      transition:0.3s;
    }

    .nav-btn:hover { 
      background:rgba(255,255,255,0.3); 
    }

    /* ===== Layout ===== */
    main { 
      max-width:1200px; 
      margin:24px auto; 
      padding:0 16px; 
    }

    .top-actions { 
      margin-bottom:18px; 
      display:flex; 
      gap:12px; 
      align-items:center; 
      flex-wrap:wrap; 
    }

    .grid { 
      display:grid; 
      grid-template-columns:repeat(2,1fr); 
      gap:18px; 
    }

    @media(max-width:880px) { 
      .grid { grid-template-columns:1fr; } 
    }

    /* ===== Cards ===== */
    .card {
      background:var(--card-bg);
      border-radius:12px;
      padding:16px;
      box-shadow:0 8px 20px rgba(0,0,0,0.08);
      border:2px solid rgba(199,40,40,0.08);
    }

    .card h3 { 
      margin:0 0 12px 0; 
      color:var(--red-600); 
      font-size:18px; 
    }

    /* ===== Buttons ===== */
    .btn {
      background:var(--red-600); 
      color:#fff; 
      border:none;
      padding:8px 14px; 
      border-radius:10px; 
      cursor:pointer;
      font-weight:700; 
      font-size:14px;
      box-shadow:0 6px 14px rgba(0,0,0,0.1);
      transition:0.2s;
    }

    .btn:hover { 
      opacity:0.9; 
      transform:translateY(-1px); 
    }

    .btn.danger { 
      background:#ff5050; 
    }

    .btn.secondary { 
      background:#555; 
    }

    /* ===== Text Styles ===== */
    .small-muted { 
      font-size:13px; 
      color:#666; 
    }

    .tiny { 
      font-size:12px; 
      color:#444; 
    }

    .tiny2 { 
      font-size:12px; 
      color:#fff; 
    }

    /* ===== List Items ===== */
    .list-item {
      background:#fff6f6; 
      border:1px solid rgba(199,40,40,0.12);
      padding:10px; 
      border-radius:8px; 
      margin-bottom:10px;
    }

    .action-row { 
      margin-top:8px; 
      display:flex; 
      gap:8px; 
      flex-wrap:wrap; 
    }

    /* ===== Scrollable Lists ===== */
    #eventListPending,
    #eventListCompleted,
    #leaveList,
    #engineerList,
    #salesList,
    #managerList,
    #adminList,
    #workerList,
    #assignerList {
      max-height: 350px;
      overflow-y: auto;
      padding-right:6px;
    }

    #eventListPending::-webkit-scrollbar,
    #eventListCompleted::-webkit-scrollbar,
    #leaveList::-webkit-scrollbar,
    #engineerList::-webkit-scrollbar,
    #salesList::-webkit-scrollbar,
    #managerList::-webkit-scrollbar,
    #adminList::-webkit-scrollbar,
    #workerList::-webkit-scrollbar,
    #assignerList::-webkit-scrollbar {
      width:6px; 
    }

    #eventListPending::-webkit-scrollbar-thumb,
    #eventListCompleted::-webkit-scrollbar-thumb,
    #leaveList::-webkit-scrollbar-thumb,
    #engineerList::-webkit-scrollbar-thumb,
    #salesList::-webkit-scrollbar-thumb,
    #managerList::-webkit-scrollbar-thumb,
    #adminList::-webkit-scrollbar-thumb,
    #workerList::-webkit-scrollbar-thumb,
    #assignerList::-webkit-scrollbar-thumb {
      background:#c00; 
      border-radius:4px;
    }

    #eventListPending::-webkit-scrollbar-track,
    #eventListCompleted::-webkit-scrollbar-track,
    #leaveList::-webkit-scrollbar-track,
    #engineerList::-webkit-scrollbar-track,
    #salesList::-webkit-scrollbar-track,
    #managerList::-webkit-scrollbar-track,
    #adminList::-webkit-scrollbar-track,
    #workerList::-webkit-scrollbar-track,
    #assignerList::-webkit-scrollbar-track {
      background:#ffe5e5;
    }

    /* ===== Responsive Grid ===== */
    @media(max-width:1024px) {
      .card div[style*="grid-template-columns:repeat(4"] {
        grid-template-columns: repeat(2, 1fr) !important;
      }
    }

    @media(max-width:640px) {
      .card div[style*="grid-template-columns:repeat(4"] {
        grid-template-columns: 1fr !important;
      }
    }

    /* ===== Inputs ===== */
    input[type="text"], 
    input[type="password"], 
    select {
      padding:8px 10px; 
      border-radius:8px; 
      border:1px solid #ddd;
      font-size:14px;
    }

    .input-row { 
      display:flex; 
      gap:12px; 
      flex-wrap:wrap; 
      align-items:center; 
      margin-bottom:12px; 
    }

    .input-row input { 
      flex:1; 
      min-width:200px; 
    }

    /* ===== Footer ===== */
    footer {
      background:linear-gradient(90deg,#c00,#f44336);
      color:#fff; 
      padding:12px; 
      text-align:center; 
      margin-top:30px;
      box-shadow:0 -3px 6px rgba(0,0,0,0.1);
    }

    /* ===== Calendar ===== */
    #holidayCalendar { 
      min-height:300px; 
    }

    /* ===== Debug Info ===== */
    .debug-info {
      background:#fffacd;
      border:1px solid #ffd700;
      padding:8px;
      border-radius:6px;
      font-size:11px;
      margin-top:8px;
      max-height:150px;
      overflow-y:auto;
    }
  </style>
</head>
<body>

<header>
  <div class="logo-title">
    <img src="ad_logo-Photoroom.png" alt="logo" onerror="this.style.display='none'" />
    <div>
      <div style="font-weight:800; font-size:18px;">üõ† ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ AUTODIDACTIC (Admin)</div>
      <div class="tiny2">Dashboard - ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô ‡∏ß‡∏±‡∏ô‡∏•‡∏≤ ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠ ‡πÅ‡∏•‡∏∞‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î</div>
    </div>
  </div>
  <nav>
    <a href="calendar_admin.html" class="nav-btn">‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</a>
  </nav>
</header>

<main>
  <div class="top-actions">
    <a href="calendar_admin.html" class="btn">‚Üê ‡∏Å‡∏•‡∏±‡∏ö</a>
    <a href="export-csv.html" class="btn secondary">‚¨á Export CSV</a>
    <div style="flex:1"></div>
    <div class="small-muted">¬© 2025 AUTODIDACTIC</div>
  </div>

  <div class="grid">

    <!-- ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£ -->
    <section class="card">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
        <h3 style="margin:0;">üìã ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô (‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£)</h3>
        <button onclick="printPendingEvents()" class="btn secondary">üñ®Ô∏è ‡∏õ‡∏£‡∏¥‡πâ‡∏ô</button>
      </div>
      <div id="eventListPending" class="small-muted">‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>
    </section>

    <!-- ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ß‡∏±‡∏ô‡∏•‡∏≤ -->
    <section class="card">
      <h3>üèñ ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ß‡∏±‡∏ô‡∏•‡∏≤</h3>
      <div id="leaveList" class="small-muted">‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>
    </section>

    <!-- ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ -->
    <section class="card">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
        <h3 style="margin:0;">üìã ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô (‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢)</h3>
        <button onclick="printCompletedEvents()" class="btn secondary">üñ®Ô∏è ‡∏õ‡∏£‡∏¥‡πâ‡∏ô</button>
      </div>
      <div id="eventListCompleted" class="small-muted">‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>
    </section>

    <!-- ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏£‡∏∞‡∏ö‡∏ö -->
    <section class="card" style="grid-column:1 / -1;">
      <h3>üë• ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏£‡∏∞‡∏ö‡∏ö (Users)</h3>

      <div class="input-row">
        <input id="userName" type="text" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ (name)" style="flex:2;">
        <input id="userUserId" type="text" placeholder="userId (‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÉ‡∏™‡πà‡πÉ‡∏ä‡πâ auto ID)" style="flex:1;">
        <input id="userPassword" type="password" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô (password)" style="flex:1;">
        <select id="userPosition" style="width:150px;">
          <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</option>
          <option value="engineer">Engineer</option>
          <option value="sales">Sales</option>
          <option value="manager">Manager</option>
          <option value="admin">Admin</option>
        </select>
        <button id="addUserBtn" class="btn">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</button>
      </div>
      <div class="tiny" style="margin-bottom:12px;">‡∏´‡∏≤‡∏Å‡πÑ‡∏°‡πà‡πÉ‡∏™‡πà userId ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡πÉ‡∏ä‡πâ document ID ‡πÄ‡∏õ‡πá‡∏ô userId ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</div>

      <div style="display:grid; grid-template-columns:repeat(4,1fr); gap:12px; margin-top:12px;">
        <div>
          <h4 class="small-muted">üîß Engineer</h4>
          <div id="engineerList">‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>
        </div>
        <div>
          <h4 class="small-muted">üíº Sales</h4>
          <div id="salesList">‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>
        </div>
        <div>
          <h4 class="small-muted">üëî Manager</h4>
          <div id="managerList">‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>
        </div>
        <div>
          <h4 class="small-muted">‚öôÔ∏è Admin</h4>
          <div id="adminList">‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>
        </div>
      </div>
    </section>
    <!-- ‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î -->
    <section class="card" style="grid-column:1 / -1;">
      <h3>üè¢ ‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó</h3>
      <div id="holidayCalendar"></div>
      <div class="tiny" style="margin-top:8px;">üí° ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î ‚Äî ‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡∏ö</div>
    </section>

  </div>
</main>

<footer>¬© 2025 ‡∏£‡∏∞‡∏ö‡∏ö AUTODIDACTIC ‚Äî ‡∏™‡∏á‡∏ß‡∏ô‡∏•‡∏¥‡∏Ç‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå</footer>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import {
  getDatabase, ref, get, set, push, remove, update, onValue
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

/* ---------------- Firebase Config ---------------- */
const firebaseConfig = {
  apiKey: "AIzaSyABY8jkjB2RD3RPK-qQ6kJThm32Pc9OpKE",
  authDomain: "events-93cb9.firebaseapp.com",
  databaseURL: "https://events-93cb9-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "events-93cb9",
  storageBucket: "events-93cb9.firebasestorage.app",
  messagingSenderId: "234410411694",
  appId: "1:234410411694:web:b544058bce0dfe78a88f3f",
  measurementId: "G-4D3X216R1K"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const $ = id => document.getElementById(id);


/* ---------------- Date Utils ---------------- */
function formatDateThai(dateStr) {
  if (!dateStr) return "-";
  const [y, m, d] = dateStr.split("-");
  return `${d}/${m}/${+y + 543}`;
}

/* ---------------- Ensure Default Data ---------------- */
async function ensureDefaultDocs() {
  try {
    if (!(await get(ref(db, "Days/leaves"))).exists()) {
      await push(ref(db, "Days/leaves"), {
        name: "User A",
        reason: "‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°",
        start: "2025-01-10",
        end: "2025-01-10"
      });
    }

    if (!(await get(ref(db, "Days/holidays"))).exists()) {
      await push(ref(db, "Days/holidays"), { 
        name: "‡∏ß‡∏±‡∏ô‡∏Ç‡∏∂‡πâ‡∏ô‡∏õ‡∏µ‡πÉ‡∏´‡∏°‡πà", 
        date: "2025-01-01" 
      });
    }

    if (!(await get(ref(db, "events"))).exists()) {
      await push(ref(db, "events"), {
        jobNumber: "JOB-000",
        location: "‡∏™‡∏≥‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏ç‡πà",
        start: "2025-01-01",
        end: "2025-01-02",
        status: "‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥",
        workers: ["User A"],
        assigners: ["Admin"],
        jobTypes: ["‡∏ó‡∏î‡∏™‡∏≠‡∏ö"]
      });
    }
  } catch (e) {
    console.warn("ensureDefaultDocs error:", e);
  }
}

/* ---------------- EVENTS ---------------- */
let allEventsData = {};

// ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÑ‡∏ß‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏¥‡πâ‡∏ô
function loadEvents() {
  const pending = $("eventListPending");
  const completed = $("eventListCompleted");

  onValue(ref(db, "events"), snap => {
    pending.innerHTML = "";
    completed.innerHTML = "";
    allEventsData = {}; // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤

    if (!snap.exists()) {
      pending.innerHTML = completed.innerHTML = "<i>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏á‡∏≤‡∏ô</i>";
      return;
    }

    allEventsData = snap.val(); // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î

    Object.entries(snap.val()).forEach(([id, d]) => {
      const div = document.createElement("div");
      div.className = "list-item";
      div.innerHTML = `
        <b>${d.jobNumber || "-"}</b> - ${d.location || "-"}<br>
        <span class="tiny">${formatDateThai(d.start)} ‚Üí ${formatDateThai(d.end)}</span>
        <div class="action-row">
          <button class="btn" onclick="editEvent('${id}')">‚úè</button>
          <button class="btn danger" onclick="deleteEvent('${id}')">üóë</button>
          <button class="btn secondary" onclick="printSingleEvent('${id}')">üñ®Ô∏è</button>
        </div>
      `;
      (["‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢","‡πÑ‡∏°‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢"].includes(d.status)
        ? completed
        : pending).appendChild(div);
    });
  });
}

window.deleteEvent = id => {
  if (confirm("‡∏•‡∏ö‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ?")) remove(ref(db, `events/${id}`));
};

window.editEvent = id => {
  location.href = `edit.html?id=${id}`;
};

/* ---------------- LEAVES (Days/leaves) ---------------- */
function loadLeaves() {
  const box = $("leaveList");
  onValue(ref(db, "Days/leaves"), snap => {
    box.innerHTML = "";
    if (!snap.exists()) {
      box.innerHTML = "<i>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡∏±‡∏ô‡∏•‡∏≤</i>";
      return;
    }

    Object.entries(snap.val()).forEach(([id, d]) => {
      const div = document.createElement("div");
      div.className = "list-item";
      div.innerHTML = `
        <b>${d.name}</b> (${d.reason})<br>
        <span class="tiny">${formatDateThai(d.start)} ‚Üí ${formatDateThai(d.end)}</span>
        <div class="action-row">
          <button class="btn" onclick="editLeave('${id}','${encodeURIComponent(d.name)}')">‚úè</button>
          <button class="btn danger" onclick="deleteLeave('${id}')">üóë</button>
        </div>
      `;
      box.appendChild(div);
    });
  });
}

window.deleteLeave = id => {
  if (confirm("‡∏•‡∏ö‡∏ß‡∏±‡∏ô‡∏•‡∏≤‡∏ô‡∏µ‡πâ?")) remove(ref(db, `Days/leaves/${id}`));
};

window.editLeave = (id, name) => {
  location.href = `editLeave.html?id=${id}&name=${name}`;
};

/* ---------------- USERS ---------------- */
function loadUsers() {
  const boxes = {
    engineer: $("engineerList"),
    sales: $("salesList"),
    manager: $("managerList"),
    admin: $("adminList")
  };

  onValue(ref(db, "users"), snap => {
    Object.values(boxes).forEach(b => b.innerHTML = "");
    if (!snap.exists()) return;

    Object.entries(snap.val()).forEach(([id, u]) => {
      const div = document.createElement("div");
      div.className = "list-item";
      div.innerHTML = `
        <b>${u.name}</b><br>
        <span class="tiny">${u.userId}</span>
        <div class="action-row">
          <button class="btn danger" onclick="deleteUser('${id}')">üóë</button>
        </div>
      `;
      boxes[u.position]?.appendChild(div);
    });
  });
}

window.deleteUser = id => {
  if (confirm("‡∏•‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ?")) remove(ref(db, `users/${id}`));
};

$("addUserBtn").onclick = async () => {
  const name = $("userName").value.trim();
  const password = $("userPassword").value;
  const position = $("userPosition").value;
  let uid = $("userUserId").value.trim();

  if (!name || !password || !position) return alert("‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö");

  const r = push(ref(db, "users"));  // ‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏õ‡∏ó‡∏µ‡πà users
  await set(r, { name, password, position, userId: uid || r.key });

  $("userName").value = $("userPassword").value = $("userUserId").value = "";
  $("userPosition").value = "";
};

/* ---------------- WORKER/ASSIGNER LISTS (‡∏à‡∏≤‡∏Å users ‡∏ï‡∏≤‡∏° position) ---------------- */
function loadWorkerAssignerFromUsers() {
  const workerBox = $("workerList");  // ‚úÖ ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏à‡∏≤‡∏Å engineerList
  const assignerBox = $("assignerList");  // ‚úÖ ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏à‡∏≤‡∏Å salesList
  const workerDebugBox = $("workerDebug");  // ‚úÖ ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏à‡∏≤‡∏Å engineerDebug
  const assignerDebugBox = $("assignerDebug");  // ‚úÖ ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏à‡∏≤‡∏Å salesDebug

  onValue(ref(db, "users"), snap => {
    console.log("=== Loading Worker/Assigner from users ===");
    
    workerBox.innerHTML = "";
    assignerBox.innerHTML = "";
    
    if (debugMode) {
      workerDebugBox.innerHTML = "<b>Debug Info:</b><br>";
      assignerDebugBox.innerHTML = "<b>Debug Info:</b><br>";
    }
    
    if (!snap.exists()) {
      console.log("‚ùå No users found");
      workerBox.innerHTML = assignerBox.innerHTML = "<i>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• users</i>";
      return;
    }

    const users = snap.val();
    console.log("üìä Total users found:", Object.keys(users).length);
    
    let engineerCount = 0;
    let salesCount = 0;
    const debugData = {
      engineers: [],
      sales: [],
      other: []
    };

    Object.entries(users).forEach(([id, u]) => {
      const positionValue = u.position || "";
      const position = String(positionValue).toLowerCase().trim();
      
      console.log(`üìù User: ${u.name}`);
      console.log(`   - Position value: "${positionValue}"`);
      console.log(`   - Normalized: "${position}"`);
      
      if (position === "engineer") {
        console.log(`   ‚úÖ ‚Üí ENGINEER`);
        engineerCount++;
        
        const div = document.createElement("div");
        div.className = "list-item";
        div.innerHTML = `
          <b>${u.name}</b><br>
          <span class="tiny">Position: ${positionValue}</span>
        `;
        workerBox.appendChild(div);  // ‚úÖ ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô workerBox
        
        debugData.engineers.push(`${u.name} (${positionValue})`);
      }
      else if (position === "sales") {
        console.log(`   ‚úÖ ‚Üí SALES`);
        salesCount++;
        
        const div = document.createElement("div");
        div.className = "list-item";
        div.innerHTML = `
          <b>${u.name}</b><br>
          <span class="tiny">Position: ${positionValue}</span>
        `;
        assignerBox.appendChild(div);  // ‚úÖ ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô assignerBox
        
        debugData.sales.push(`${u.name} (${positionValue})`);
      }
      else {
        console.log(`   ‚ö†Ô∏è ‚Üí OTHER (not matched)`);
        debugData.other.push(`${u.name} (position: "${positionValue}")`);
      }
    });

    if (engineerCount === 0) {
      workerBox.innerHTML = `<i>‡πÑ‡∏°‡πà‡∏°‡∏µ Engineers<br>(‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ position = 'engineer')</i>`;
    }
    
    if (salesCount === 0) {
      assignerBox.innerHTML = `<i>‡πÑ‡∏°‡πà‡∏°‡∏µ Sales<br>(‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ position = 'sales')</i>`;
    }

    if (debugMode) {
      workerDebugBox.innerHTML += `
        <b>Engineers found: ${engineerCount}</b><br>
        ${debugData.engineers.length > 0 ? debugData.engineers.join("<br>") : "None"}<br><br>
        <b>Other users (${debugData.other.length}):</b><br>
        ${debugData.other.join("<br>")}
      `;
      
      assignerDebugBox.innerHTML += `
        <b>Sales found: ${salesCount}</b><br>
        ${debugData.sales.length > 0 ? debugData.sales.join("<br>") : "None"}<br><br>
        <b>Other users (${debugData.other.length}):</b><br>
        ${debugData.other.join("<br>")}
      `;
    }
    
    console.log(`‚úÖ Summary: ${engineerCount} engineers, ${salesCount} sales loaded`);
    console.log(`Other users: ${debugData.other.length}`);
  }, (error) => {
    console.error("‚ùå Error loading users:", error);
    workerBox.innerHTML = assignerBox.innerHTML = "<i>‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</i>";
  });
}

/* ---------------- HOLIDAY CALENDAR (Days/holidays) ---------------- */
let calendar;

function initHolidayCalendar() {
  const calendarEl = $("holidayCalendar");
  
  calendar = new FullCalendar.Calendar(calendarEl, {
    initialView: 'dayGridMonth',
    locale: 'th',
    headerToolbar: {
      left: 'prev,next today',
      center: 'title',
      right: 'dayGridMonth,dayGridYear'
    },
    buttonText: {
      today: '‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ',
      month: '‡πÄ‡∏î‡∏∑‡∏≠‡∏ô',
      year: '‡∏õ‡∏µ'
    },
    
    // ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ß‡∏±‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î
    dateClick: function(info) {
      const holidayName = prompt("‡∏ä‡∏∑‡πà‡∏≠‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î:", "‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î‡∏û‡∏¥‡πÄ‡∏®‡∏©");
      if (holidayName) {
        addHoliday(holidayName, info.dateStr);
      }
    },
    
    // ‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡∏ö‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î
    eventClick: function(info) {
      if (confirm(`‡∏•‡∏ö‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î "${info.event.title}"?`)) {
        deleteHoliday(info.event.id);
      }
    },
    
    events: []
  });

  calendar.render();
  loadHolidays();
}

function loadHolidays() {
  onValue(ref(db, "Days/holidays"), snap => {
    calendar.removeAllEvents();
    
    if (!snap.exists()) return;

    Object.entries(snap.val()).forEach(([id, h]) => {
      calendar.addEvent({
        id: id,
        title: h.name || "‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î",
        start: h.date,
        allDay: true,
        backgroundColor: '#ff5252',
        borderColor: '#c00'
      });
    });
  });
}

async function addHoliday(name, date) {
  try {
    await push(ref(db, "Days/holidays"), {
      name: name,
      date: date
    });
  } catch (e) {
    alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + e.message);
  }
}

async function deleteHoliday(id) {
  try {
    await remove(ref(db, `Days/holidays/${id}`));
  } catch (e) {
    alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + e.message);
  }
}

/* ---------------- INITIALIZATION ---------------- */
(async () => {
  await ensureDefaultDocs();
  loadEvents();
  loadLeaves();
  loadUsers();
  loadWorkerAssignerFromUsers();
  initHolidayCalendar();
})();

/* ---------------- PRINT FUNCTIONS ---------------- */
window.printPendingEvents = () => {
  const pendingEvents = Object.entries(allEventsData)
    .filter(([_, d]) => !["‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢","‡πÑ‡∏°‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢"].includes(d.status));
  
  // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô localStorage ‡πÅ‡∏•‡∏∞‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤ reportS.html
  localStorage.setItem('printData', JSON.stringify({
    events: pendingEvents,
    title: "‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô (‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£)"
  }));
  window.open('reportS.html', '_blank');
};

window.printCompletedEvents = () => {
  const completedEvents = Object.entries(allEventsData)
    .filter(([_, d]) => ["‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢","‡πÑ‡∏°‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢"].includes(d.status));
  
  // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô localStorage ‡πÅ‡∏•‡∏∞‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤ reportS.html
  localStorage.setItem('printData', JSON.stringify({
    events: completedEvents,
    title: "‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô (‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢)"
  }));
  window.open('reportS.html', '_blank');
};

/* ---------------- PRINT FUNCTIONS ---------------- */
window.printPendingEvents = () => {
  const pendingEvents = Object.entries(allEventsData)
    .filter(([_, d]) => !["‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢","‡πÑ‡∏°‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢"].includes(d.status));
  
  if (pendingEvents.length === 0) {
    alert("‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏¥‡πâ‡∏ô");
    return;
  }
  
  // ‡∏™‡πà‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞ jobNumber ‡πÑ‡∏õ
  const jobNumbers = pendingEvents.map(([_, d]) => d.jobNumber).filter(Boolean).join(',');
  window.open(`reportS.html?jobs=${encodeURIComponent(jobNumbers)}&title=${encodeURIComponent("‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô (‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£)")}`, '_blank');
};

/* ---------------- PRINT FUNCTIONS ---------------- */
window.printPendingEvents = () => {
  const pendingEvents = Object.entries(allEventsData)
    .filter(([_, d]) => !["‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢","‡πÑ‡∏°‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢"].includes(d.status));
  
  if (pendingEvents.length === 0) {
    alert("‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏¥‡πâ‡∏ô");
    return;
  }
  
  // ‡∏™‡∏£‡πâ‡∏≤‡∏á URL parameters ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏á‡∏≤‡∏ô
  const params = pendingEvents.map(([_, d]) => 
    `job=${encodeURIComponent(d.jobNumber || '')}&start=${encodeURIComponent(d.start || '')}&end=${encodeURIComponent(d.end || '')}`
  ).join('&');
  
  window.open(`reportS.html?${params}&title=${encodeURIComponent("‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô (‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£)")}`, '_blank');
};

window.printCompletedEvents = () => {
  const completedEvents = Object.entries(allEventsData)
    .filter(([_, d]) => ["‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢","‡πÑ‡∏°‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢"].includes(d.status));
  
  if (completedEvents.length === 0) {
    alert("‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏¥‡πâ‡∏ô");
    return;
  }
  
  // ‡∏™‡∏£‡πâ‡∏≤‡∏á URL parameters ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏á‡∏≤‡∏ô
  const params = completedEvents.map(([_, d]) => 
    `job=${encodeURIComponent(d.jobNumber || '')}&start=${encodeURIComponent(d.start || '')}&end=${encodeURIComponent(d.end || '')}&position=${encodeURIComponent(d.position || '')}`
  ).join('&');
  
  window.open(`report.html?${params}&title=${encodeURIComponent("‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô (‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢)")}`, '_blank');
};

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏õ‡∏£‡∏¥‡πâ‡∏ô‡∏á‡∏≤‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß
window.printSingleEvent = (eventId) => {
  if (!allEventsData[eventId]) {
    alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏á‡∏≤‡∏ô");
    return;
  }
  
  const event = allEventsData[eventId];

  // ‡∏™‡πà‡∏á job, start, end, position ‡πÑ‡∏õ
  const params = `job=${encodeURIComponent(event.jobNumber || '')}&start=${encodeURIComponent(event.start || '')}&end=${encodeURIComponent(event.end || '')}&position=${encodeURIComponent(event.position || '')}`;
  
  window.open(`reportS.html?${params}&title=${encodeURIComponent(`‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏á‡∏≤‡∏ô - ${event.jobNumber || "‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏"}`)}`, '_blank');
};
</script>

</body>
</html>