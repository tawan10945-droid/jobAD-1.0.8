<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏á‡∏≤‡∏ô | AUTODIDACTIC</title>
<style>
body {
  font-family: 'Prompt', sans-serif;
  background: linear-gradient(to bottom, #fff, #fee);
  color: #c00;
  margin: 0;
  display: flex;
  flex-direction: column;
  align-items: center;
  min-height: 100vh;
}

/* ===== Header ===== */
header {
  width: 100%;
  background: #c00;
  color: #fff;
  padding: 12px 20px;
  text-align: center;
  font-weight: bold;
  box-shadow: 0 3px 8px rgba(0,0,0,0.15);
}
header a {
  position: absolute;
  left: 20px;
  top: 12px;
  background: rgba(255,255,255,0.2);
  color: #fff;
  padding: 6px 12px;
  border-radius: 8px;
  text-decoration: none;
}
header a:hover { background: rgba(255,255,255,0.35); }

form {
  width: 100%;
  max-width: 520px;
  background: #fff;
  border: 2px solid #c00;
  padding: 25px;
  margin: 30px 0;
  border-radius: 12px;
  box-shadow: 0 6px 15px rgba(0,0,0,0.08);
}
h2 { text-align: center; margin-top: 0; color: #c00; }

.input-line {
  width: 100%;
  padding: 10px;
  margin: 10px 0;
  border: 2px solid #c00;
  border-radius: 8px;
  outline: none;
  font-size: 15px;
  color: #c00;
  box-sizing: border-box;
}
textarea.input-line { height: 90px; resize: none; }

select.input-line {
  background: #fff;
}

button {
  width: 100%;
  padding: 12px;
  margin-top: 15px;
  border-radius: 8px;
  background: #c00;
  color: #fff;
  font-weight: bold;
  border: none;
  cursor: pointer;
  font-size: 16px;
  transition: 0.3s;
}
button:hover { background: #a00; transform: scale(1.02); }

a.btn-back {
  display: inline-block;
  text-align: center;
  background: #888;
  color: #fff;
  padding: 10px 18px;
  border-radius: 8px;
  text-decoration: none;
  font-weight: 600;
  margin-top: 8px;
}
a.btn-back:hover { background: #555; }

/* ===== Dropdown ===== */
.dropdown { position: relative; width: 100%; margin-bottom: 12px; }
.dropdown-btn {
  width: 100%;
  padding: 8px 10px;
  border: 2px solid #c00;
  border-radius: 8px;
  background: #fff;
  color: #c00;
  font-size: 15px;
  text-align: left;
  cursor: pointer;
  display: flex;
  flex-wrap: wrap;
  gap: 6px;
  min-height: 36px;
  align-items: center;
}
.dropdown-content {
  display: none;
  position: absolute;
  background-color: #fff;
  border: 1px solid #c00;
  border-radius: 8px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.15);
  z-index: 10;
  width: 100%;
  max-height: 200px;
  overflow-y: auto;
  padding: 5px;
}
.dropdown-content label {
  display: flex;
  align-items: center;
  padding: 6px 10px;
  cursor: pointer;
}
.dropdown-content label:hover { background: #fee; }
.selected-name {
  background: #c00;
  color: #fff;
  border-radius: 12px;
  padding: 2px 6px;
  font-size: 13px;
}

footer {
  background: #c00;
  color: #fff;
  text-align: center;
  padding: 10px;
  font-size: 13px;
  margin-top: auto;
  width: 100%;
}
</style>
</head>

<body>

<header>
  <a href="adminV2.html">‚¨Ö ‡∏Å‡∏•‡∏±‡∏ö</a>
  ‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏á‡∏≤‡∏ô | AUTODIDACTIC
</header>

<form id="editForm">
  <input type="hidden" id="eventId">

  <label>‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏á‡∏≤‡∏ô:</label>
  <input type="text" id="job" class="input-line">

  <label>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏á‡∏≤‡∏ô:</label>
  <input type="text" id="jobNumber" class="input-line">

  <label>‡∏ú‡∏π‡πâ‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô:</label>
  <div class="dropdown">
    <button type="button" class="dropdown-btn" id="titleBtn">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠</button>
    <div class="dropdown-content" id="titleList"></div>
  </div>

  <label>‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà:</label>
  <input type="text" id="location" class="input-line" required>

  <label>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏á‡∏≤‡∏ô:</label>
  <textarea id="details" class="input-line" required></textarea>

  <label>‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏±‡πà‡∏á‡∏á‡∏≤‡∏ô:</label>
  <div class="dropdown">
    <button type="button" class="dropdown-btn" id="assignedByBtn">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠</button>
    <div class="dropdown-content" id="assignedByList"></div>
  </div>

  <label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°:</label>
  <input type="date" id="start" class="input-line" required>

  <label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î:</label>
  <input type="date" id="end" class="input-line" required>

  <label>‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á:</label>
  <textarea id="howto" class="input-line"></textarea>

  <label>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞:</label>
  <select id="status" class="input-line">
    <option value="‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥">‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</option>
    <option value="‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏î‡πà‡∏ß‡∏ô">‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏î‡πà‡∏ß‡∏ô</option>
    <option value="‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥">‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</option>
    <option value="‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏î‡πà‡∏ß‡∏ô">‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏î‡πà‡∏ß‡∏ô</option>
    <option value="‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢">‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢</option>
    <option value="‡πÑ‡∏°‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢">‡πÑ‡∏°‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢</option>
  </select>

  <button type="submit">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
  <a href="adminV2.html" class="btn-back">‡∏Å‡∏•‡∏±‡∏ö</a>
</form>

<footer>¬© 2025 AUTODIDACTIC SYSTEM</footer>

<script type="module">
/* -----------------------------------
   Firebase Config (events-666d6) - RTDB
----------------------------------- */
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
import { getDatabase, ref, get, update, child } 
from "https://www.gstatic.com/firebasejs/12.3.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyABY8jkjB2RD3RPK-qQ6kJThm32Pc9OpKE",
  authDomain: "events-93cb9.firebaseapp.com",
  databaseURL: "https://events-93cb9-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "events-93cb9",
  storageBucket: "events-93cb9.firebasestorage.app",
  messagingSenderId: "234410411694",
  appId: "1:234410411694:web:b544058bce0dfe78a88f3f",
  measurementId: "G-4D3X216R1K"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

/* -----------------------------------
   Params
----------------------------------- */
const params = new URLSearchParams(window.location.search);
const eventId = params.get("id");

const titleList = document.getElementById("titleList");
const assignedByList = document.getElementById("assignedByList");
const titleBtn = document.getElementById("titleBtn");
const assignedByBtn = document.getElementById("assignedByBtn");

/* ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏Ñ‡∏ô‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ß‡πà‡∏≤‡∏á‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà */
async function isWorkerAvailable(workerName, startDate, endDate, currentEventId) {
  // ‡πÅ‡∏õ‡∏•‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô timestamp ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö
  const start = new Date(startDate).getTime();
  const end = new Date(endDate).getTime();

  // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏à‡∏≤‡∏Å Days/leaves
  const leavesRef = ref(db, "Days/leaves");
  const leavesSnap = await get(leavesRef);
  if (leavesSnap.exists()) {
    const leavesData = leavesSnap.val();
    for (const key in leavesData) {
      const leave = leavesData[key];
      // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
      if (leave.name === workerName || (leave.workers && leave.workers.includes(workerName))) {
        const leaveStart = new Date(leave.start).getTime();
        const leaveEnd = new Date(leave.end).getTime();
        
        // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏±‡∏ö‡∏ã‡πâ‡∏≠‡∏ô‡∏Å‡∏±‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
        if (!(end < leaveStart || start > leaveEnd)) {
          return false; // ‡∏°‡∏µ‡∏ß‡∏±‡∏ô‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏ó‡∏±‡∏ö‡∏ã‡πâ‡∏≠‡∏ô
        }
      }
    }
  }

  // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏à‡∏≤‡∏Å events (‡∏á‡∏≤‡∏ô‡∏≠‡∏∑‡πà‡∏ô‡πÜ)
  const eventsRef = ref(db, "events");
  const eventsSnap = await get(eventsRef);
  if (eventsSnap.exists()) {
    const eventsData = eventsSnap.val();
    for (const key in eventsData) {
      // ‡∏Ç‡πâ‡∏≤‡∏°‡∏á‡∏≤‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
      if (key === currentEventId) continue;
      
      const event = eventsData[key];
      // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
      const workers = event.workers || [];
      const workersArray = Array.isArray(workers) ? workers : (workers ? Object.values(workers) : []);
      
      if (workersArray.includes(workerName)) {
        const eventStart = new Date(event.start).getTime();
        const eventEnd = new Date(event.end).getTime();
        
        // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏±‡∏ö‡∏ã‡πâ‡∏≠‡∏ô‡∏Å‡∏±‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
        if (!(end < eventStart || start > eventEnd)) {
          return false; // ‡∏°‡∏µ‡∏á‡∏≤‡∏ô‡∏≠‡∏∑‡πà‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏±‡∏ö‡∏ã‡πâ‡∏≠‡∏ô
        }
      }
    }
  }

  return true; // ‡∏Ñ‡∏ô‡∏ô‡∏µ‡πâ‡∏ß‡πà‡∏≤‡∏á
}

/* ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏≤‡∏Å users ‡∏ï‡∏≤‡∏° status ‡πÅ‡∏•‡∏∞ position */
async function loadDropdowns() {
  titleList.innerHTML = "";
  assignedByList.innerHTML = "";

  const startDate = document.getElementById("start").value;
  const endDate = document.getElementById("end").value;

  // ‡πÇ‡∏´‡∏•‡∏î users
  const usersRef = ref(db, "users");
  const usersSnap = await get(usersRef);
  
  console.log("Users snapshot exists:", usersSnap.exists());
  
  if (usersSnap.exists()) {
    const usersData = usersSnap.val();
    console.log("Users data:", usersData);
    
    for (const userId in usersData) {
      const user = usersData[userId];
      console.log("Processing user:", userId, user);
      
      const name = user.name || user.username || user.displayName;
      const stutus = user.stutus; // ‡πÉ‡∏ä‡πâ stutus ‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏°‡∏µ‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡∏™‡∏∞‡∏Å‡∏î‡∏ú‡∏¥‡∏î)
      const position = user.position;
      
      console.log(`User: ${name}, Status: ${stutus}, Position: ${position}`);
      
      // ‡∏ú‡∏π‡πâ‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô: position = engineer ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
      if (position === "engineer") {
        console.log(`Adding ${name} to workers list`);
        
        // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏Ñ‡∏ô‡∏ô‡∏µ‡πâ‡∏ß‡πà‡∏≤‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å)
        let isAvailable = true;
        let availabilityNote = "";
        
        if (startDate && endDate) {
          isAvailable = await isWorkerAvailable(name, startDate, endDate, eventId);
          if (!isAvailable) {
            availabilityNote = " <span style='color: #888;'>(‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏á)</span>";
          }
        }
        
        const disabled = !isAvailable ? "disabled" : "";
        const style = !isAvailable ? "style='opacity: 0.5;'" : "";
        
        titleList.innerHTML += `<label ${style}><input type="checkbox" value="${name}" ${disabled}> ${name}${availabilityNote}</label>`;
      }
      
      // ‡∏Ñ‡∏ô‡∏™‡∏±‡πà‡∏á‡∏á‡∏≤‡∏ô: position = sales
      if (position === "sales") {
        console.log(`Adding ${name} to assigners list`);
        assignedByList.innerHTML += `<label><input type="checkbox" value="${name}"> ${name}</label>`;
      }
    }
  } else {
    console.log("No users data found");
  }
  
  console.log("Workers list HTML:", titleList.innerHTML);
  console.log("Assigners list HTML:", assignedByList.innerHTML);
}

/* ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏á‡∏≤‡∏ô */
async function loadEventData() {
  if (!eventId) return alert("‡πÑ‡∏°‡πà‡∏û‡∏ö ID ‡∏á‡∏≤‡∏ô‡πÉ‡∏ô URL");

  const eventRef = ref(db, `events/${eventId}`);
  const snap = await get(eventRef);

  if (!snap.exists()) return alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ");
  const data = snap.val();

  document.getElementById("eventId").value = eventId;
  document.getElementById("job").value = data.job || "";
  document.getElementById("jobNumber").value = data.jobNumber || "";
  document.getElementById("location").value = data.location || "";
  document.getElementById("details").value = data.details || "";
  document.getElementById("howto").value = data.howto || "";
  document.getElementById("start").value = data.start || "";
  document.getElementById("end").value = data.end || "";
  document.getElementById("status").value = data.status || "‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥";

  await loadDropdowns();

  // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ checkbox ‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ß‡πâ
  const workers = data.workers || [];
  const assigners = data.assigners || [];

  // Handle both array and object formats
  const workersArray = Array.isArray(workers) ? workers : (workers ? Object.values(workers) : []);
  const assignersArray = Array.isArray(assigners) ? assigners : (assigners ? Object.values(assigners) : []);

  titleList.querySelectorAll("input").forEach(cb => {
    if (workersArray.includes(cb.value)) cb.checked = true;
  });
  assignedByList.querySelectorAll("input").forEach(cb => {
    if (assignersArray.includes(cb.value)) cb.checked = true;
  });

  updateDropdownButton(titleList, titleBtn);
  updateDropdownButton(assignedByList, assignedByBtn);
}

/* ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• */
document.getElementById("editForm").addEventListener("submit", async e => {
  e.preventDefault();

  const job = document.getElementById("job").value.trim();
  const jobNumber = document.getElementById("jobNumber").value.trim();
  const location = document.getElementById("location").value.trim();
  const details = document.getElementById("details").value.trim();
  const howto = document.getElementById("howto").value.trim();
  const start = document.getElementById("start").value;
  const end = document.getElementById("end").value;
  const status = document.getElementById("status").value;

  const workers = Array.from(titleList.querySelectorAll("input:checked")).map(cb => cb.value);
  const assigners = Array.from(assignedByList.querySelectorAll("input:checked")).map(cb => cb.value);

  try {
    const eventRef = ref(db, `events/${eventId}`);
    await update(eventRef, {
      job, 
      jobNumber, 
      location, 
      details, 
      howto, 
      start, 
      end, 
      status, 
      workers, 
      assigners
    });

    alert("‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß");
    window.location.href = "adminV2.html";
  } catch (error) {
    console.error("Error updating document:", error);
    alert("‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: " + error.message);
  }
});

/* ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï‡∏õ‡∏∏‡πà‡∏°‡πÅ‡∏™‡∏î‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å */
function updateDropdownButton(list, btn) {
  const selected = Array.from(list.querySelectorAll("input:checked")).map(cb => cb.value);
  btn.innerHTML = selected.length 
    ? selected.map(n => `<span class="selected-name">${n}</span>`).join(" ")
    : "‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠";
}

/* Event: ‡πÄ‡∏õ‡∏¥‡∏î dropdown */
titleBtn.addEventListener("click", () => {
  titleList.style.display = titleList.style.display === "block" ? "none" : "block";
});
assignedByBtn.addEventListener("click", () => {
  assignedByList.style.display = assignedByList.style.display === "block" ? "none" : "block";
});

/* ‡∏õ‡∏¥‡∏î dropdown ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ñ‡∏•‡∏¥‡∏Å‡∏Ç‡πâ‡∏≤‡∏á‡∏ô‡∏≠‡∏Å */
document.addEventListener("click", (e) => {
  if (!titleBtn.contains(e.target) && !titleList.contains(e.target)) {
    titleList.style.display = "none";
  }
  if (!assignedByBtn.contains(e.target) && !assignedByList.contains(e.target)) {
    assignedByList.style.display = "none";
  }
});

titleList.addEventListener("change", () => updateDropdownButton(titleList, titleBtn));
assignedByList.addEventListener("change", () => updateDropdownButton(assignedByList, assignedByBtn));

// ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ‡πÉ‡∏´‡πâ‡πÇ‡∏´‡∏•‡∏î dropdown ‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏ä‡πá‡∏Ñ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ß‡πà‡∏≤‡∏á
document.getElementById("start").addEventListener("change", async () => {
  await loadDropdowns();
  // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ß‡πâ‡πÄ‡∏î‡∏¥‡∏°
  const currentData = await getCurrentEventData();
  if (currentData && currentData.workers) {
    const workersArray = Array.isArray(currentData.workers) ? currentData.workers : Object.values(currentData.workers || {});
    titleList.querySelectorAll("input:not([disabled])").forEach(cb => {
      if (workersArray.includes(cb.value)) cb.checked = true;
    });
    updateDropdownButton(titleList, titleBtn);
  }
});

document.getElementById("end").addEventListener("change", async () => {
  await loadDropdowns();
  // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ß‡πâ‡πÄ‡∏î‡∏¥‡∏°
  const currentData = await getCurrentEventData();
  if (currentData && currentData.workers) {
    const workersArray = Array.isArray(currentData.workers) ? currentData.workers : Object.values(currentData.workers || {});
    titleList.querySelectorAll("input:not([disabled])").forEach(cb => {
      if (workersArray.includes(cb.value)) cb.checked = true;
    });
    updateDropdownButton(titleList, titleBtn);
  }
});

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ä‡πà‡∏ß‡∏¢‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• event ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
async function getCurrentEventData() {
  if (!eventId) return null;
  const eventRef = ref(db, `events/${eventId}`);
  const snap = await get(eventRef);
  return snap.exists() ? snap.val() : null;
}

loadEventData();
</script>

</body>
</html>