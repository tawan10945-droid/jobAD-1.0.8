<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Export CSV - ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô</title>
  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Prompt', sans-serif;
      background: linear-gradient(135deg, #fff5f5 0%, #ffe5e5 100%);
      color: #333;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    header {
      background: linear-gradient(135deg, #c00 0%, #a00 100%);
      color: #fff;
      padding: 24px 20px;
      box-shadow: 0 4px 20px rgba(204, 0, 0, 0.15);
      position: relative;
      overflow: hidden;
    }

    header::before {
      content: '';
      position: absolute;
      top: -50%;
      right: -50%;
      width: 200%;
      height: 200%;
      background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
      animation: pulse 15s ease-in-out infinite;
    }

    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.1); }
    }

    .header-content {
      position: relative;
      z-index: 1;
      max-width: 1200px;
      margin: 0 auto;
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .header-icon {
      font-size: 42px;
      animation: bounce 2s ease-in-out infinite;
    }

    @keyframes bounce {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-10px); }
    }

    .header-text h1 {
      font-size: 24px;
      font-weight: 700;
      margin-bottom: 4px;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
    }

    .header-text p {
      font-size: 14px;
      opacity: 0.9;
      font-weight: 300;
    }

    .container {
      flex: 1;
      max-width: 1400px;
      margin: 0 auto;
      padding: 30px 20px;
      width: 100%;
    }

    .nav-section {
      margin-bottom: 25px;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 12px 24px;
      border-radius: 12px;
      text-decoration: none;
      font-weight: 600;
      font-size: 15px;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      border: none;
      cursor: pointer;
    }

    .btn-secondary {
      background: #fff;
      color: #c00;
      border: 2px solid #c00;
    }

    .btn-secondary:hover {
      background: #c00;
      color: #fff;
      transform: translateY(-2px);
      box-shadow: 0 6px 25px rgba(204, 0, 0, 0.3);
    }

    .btn-primary {
      background: linear-gradient(135deg, #c00 0%, #a00 100%);
      color: #fff;
    }

    .btn-primary:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 6px 25px rgba(204, 0, 0, 0.3);
    }

    .btn-success {
      background: linear-gradient(135deg, #28a745 0%, #20873a 100%);
      color: #fff;
    }

    .btn-success:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 6px 25px rgba(40, 167, 69, 0.3);
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .control-card {
      background: #fff;
      padding: 30px;
      border-radius: 16px;
      box-shadow: 0 8px 30px rgba(0,0,0,0.08);
      margin-bottom: 25px;
      border: 1px solid rgba(204, 0, 0, 0.1);
      position: relative;
    }

    .control-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 4px;
      background: linear-gradient(90deg, #c00 0%, #a00 100%);
      border-radius: 16px 16px 0 0;
    }

    .card-title {
      font-size: 18px;
      font-weight: 600;
      color: #c00;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .controls-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }

    .form-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .form-group label {
      font-size: 14px;
      font-weight: 500;
      color: #666;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    input[type="month"] {
      padding: 12px 16px;
      border: 2px solid #e0e0e0;
      border-radius: 10px;
      font-size: 15px;
      font-weight: 500;
      color: #333;
      background: #fff;
      transition: all 0.3s ease;
      font-family: 'Prompt', sans-serif;
    }

    input[type="month"]:hover {
      border-color: #c00;
    }

    input[type="month"]:focus {
      outline: none;
      border-color: #c00;
      box-shadow: 0 0 0 3px rgba(204, 0, 0, 0.1);
    }

    .checkbox-group {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 12px;
      background: #fff5f5;
      border-radius: 10px;
      border: 2px solid #ffe5e5;
    }

    .checkbox-group input[type="checkbox"] {
      width: 20px;
      height: 20px;
      cursor: pointer;
      accent-color: #c00;
    }

    .checkbox-group label {
      cursor: pointer;
      font-size: 14px;
      color: #666;
      user-select: none;
    }

    .action-buttons {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      margin-top: 20px;
    }

    .message-box {
      padding: 16px 20px;
      border-radius: 12px;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 15px;
      animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .message-info {
      background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
      color: #1565c0;
      border: 2px solid #90caf9;
    }

    .message-success {
      background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
      color: #2e7d32;
      border: 2px solid #81c784;
    }

    .message-loading {
      background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%);
      color: #e65100;
      border: 2px solid #ffb74d;
    }

    .message-icon {
      font-size: 24px;
    }

    .results-card {
      background: #fff;
      padding: 30px;
      border-radius: 16px;
      box-shadow: 0 8px 30px rgba(0,0,0,0.08);
      border: 1px solid rgba(204, 0, 0, 0.1);
      position: relative;
    }

    .results-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 4px;
      background: linear-gradient(90deg, #c00 0%, #a00 100%);
      border-radius: 16px 16px 0 0;
    }

    .stats-summary {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: linear-gradient(135deg, #fff 0%, #fff5f5 100%);
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.06);
      border: 1px solid rgba(204, 0, 0, 0.1);
      transition: all 0.3s ease;
    }

    .stat-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 25px rgba(0,0,0,0.12);
    }

    .stat-label {
      font-size: 13px;
      color: #666;
      margin-bottom: 8px;
      font-weight: 500;
    }

    .stat-value {
      font-size: 32px;
      font-weight: 700;
      color: #c00;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .table-wrapper {
      overflow-x: auto;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      background: #fff;
    }

    th, td {
      padding: 14px 16px;
      text-align: left;
      border-bottom: 1px solid #f0f0f0;
    }

    th {
      background: linear-gradient(135deg, #f8f8f8 0%, #fff 100%);
      font-weight: 600;
      color: #c00;
      font-size: 14px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      position: sticky;
      top: 0;
      z-index: 10;
    }

    tbody tr {
      transition: all 0.2s ease;
    }

    tbody tr:hover {
      background: #fff5f5;
    }

    td {
      font-size: 14px;
      color: #333;
    }

    .summary-section {
      margin-top: 30px;
      padding-top: 30px;
      border-top: 2px dashed #e0e0e0;
    }

    .summary-title {
      font-size: 20px;
      font-weight: 600;
      color: #c00;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .summary-list {
      list-style: none;
      display: grid;
      gap: 12px;
    }

    .summary-item {
      padding: 16px 20px;
      background: linear-gradient(135deg, #fff 0%, #fff5f5 100%);
      border-radius: 10px;
      border-left: 4px solid #c00;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      transition: all 0.3s ease;
    }

    .summary-item:hover {
      transform: translateX(8px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    .summary-item strong {
      color: #c00;
      font-weight: 600;
      font-size: 15px;
    }

    .summary-details {
      color: #666;
      font-size: 14px;
      margin-top: 4px;
    }

    footer {
      background: linear-gradient(135deg, #c00 0%, #a00 100%);
      color: #fff;
      text-align: center;
      padding: 20px;
      margin-top: auto;
      box-shadow: 0 -4px 20px rgba(204, 0, 0, 0.15);
    }

    .footer-content p {
      font-size: 14px;
      font-weight: 300;
      opacity: 0.95;
    }

    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #999;
    }

    .empty-icon {
      font-size: 64px;
      margin-bottom: 20px;
      opacity: 0.5;
    }

    @media (max-width: 768px) {
      .header-content {
        flex-direction: column;
        text-align: center;
      }

      .header-text h1 {
        font-size: 20px;
      }

      .controls-grid {
        grid-template-columns: 1fr;
      }

      .stats-summary {
        grid-template-columns: 1fr;
      }

      .control-card, .results-card {
        padding: 20px 15px;
      }

      .action-buttons {
        flex-direction: column;
      }

      .btn {
        width: 100%;
        justify-content: center;
      }
    }

    .fade-in {
      animation: fadeIn 0.6s ease-out;
    }
  </style>
</head>
<body>

<header>
  <div class="header-content">
    <div class="header-icon">üì•</div>
    <div class="header-text">
      <h1>Export CSV ‚Äî ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô</h1>
      <p>‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏ü‡∏•‡πå CSV</p>
    </div>
  </div>
</header>

<div class="container">
  <div class="nav-section fade-in">
    <a href="manager.html" class="btn btn-secondary">
      <span>‚Üê</span>
      <span>‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</span>
    </a>
  </div>

  <div class="control-card fade-in">
    <div class="card-title">
      <span>‚öôÔ∏è</span>
      <span>‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</span>
    </div>

    <div class="controls-grid">
      <div class="form-group">
        <label>
          <span>üìÖ</span>
          <span>‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô</span>
        </label>
        <input id="startMonth" type="month" />
      </div>

      <div class="form-group">
        <label>
          <span>üìÖ</span>
          <span>‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î</span>
        </label>
        <input id="endMonth" type="month" />
      </div>

      <div class="form-group">
        <label style="margin-bottom: 4px;">
          <span>üéØ</span>
          <span>‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•</span>
        </label>
        <div class="checkbox-group">
          <input id="includeZero" type="checkbox" checked />
          <label for="includeZero">‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏î‡πâ‡∏ß‡∏¢</label>
        </div>
      </div>
    </div>

    <div class="action-buttons">
      <button id="loadBtn" class="btn btn-primary">
        <span>üîÑ</span>
        <span>‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</span>
      </button>
      <button id="exportBtn" class="btn btn-success" disabled>
        <span>‚¨áÔ∏è</span>
        <span>‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î CSV</span>
      </button>
    </div>
  </div>

  <div id="messageBox"></div>
  <div id="tableWrap"></div>
</div>

<footer>
  <div class="footer-content">
    <p>¬© 2025 AUTODIDACTIC | ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô‡∏≠‡∏±‡∏à‡∏â‡∏£‡∏¥‡∏¢‡∏∞</p>
  </div>
</footer>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
  import { getDatabase, ref, get } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-database.js";

  const firebaseConfig = {
  apiKey: "AIzaSyABY8jkjB2RD3RPK-qQ6kJThm32Pc9OpKE",
  authDomain: "events-93cb9.firebaseapp.com",
  databaseURL: "https://events-93cb9-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "events-93cb9",
  storageBucket: "events-93cb9.firebasestorage.app",
  messagingSenderId: "234410411694",
  appId: "1:234410411694:web:b544058bce0dfe78a88f3f",
  measurementId: "G-4D3X216R1K"
};

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  const startMonth = document.getElementById("startMonth");
  const endMonth = document.getElementById("endMonth");
  const includeZeroCheckbox = document.getElementById("includeZero");
  const loadBtn = document.getElementById("loadBtn");
  const exportBtn = document.getElementById("exportBtn");
  const tableWrap = document.getElementById("tableWrap");
  const messageBox = document.getElementById("messageBox");

  let currentReport = [];

  function showMessage(text, type = 'info') {
    const icons = {
      info: 'üí°',
      success: '‚úÖ',
      loading: '‚è≥'
    };
    messageBox.innerHTML = `
      <div class="message-box message-${type} fade-in">
        <span class="message-icon">${icons[type]}</span>
        <span>${text}</span>
      </div>
    `;
  }

  function toBuddhistYear(year) {
    return year + 543;
  }

  function getThaiMonth(monthNum) {
    const months = ["‡∏°.‡∏Ñ.", "‡∏Å.‡∏û.", "‡∏°‡∏µ.‡∏Ñ.", "‡πÄ‡∏°.‡∏¢.", "‡∏û.‡∏Ñ.", "‡∏°‡∏¥.‡∏¢.", 
                    "‡∏Å.‡∏Ñ.", "‡∏™.‡∏Ñ.", "‡∏Å.‡∏¢.", "‡∏ï.‡∏Ñ.", "‡∏û.‡∏¢.", "‡∏ò.‡∏Ñ."];
    return months[monthNum];
  }

  function formatMonthThai(monthStr) {
    if(!monthStr) return "";
    const [year, month] = monthStr.split("-").map(Number);
    const buddhistYear = toBuddhistYear(year);
    const thaiMonth = getThaiMonth(month - 1);
    return `${thaiMonth} ${buddhistYear}`;
  }

  function cleanText(text) {
    if (!text) return "";
    return text
      .replace(/[\u200B-\u200D\uFEFF]/g, '')
      .replace(/[\u0300-\u036F]/g, '')
      .replace(/\u0E4D/g, '\u0E48')
      .replace(/\u0E34/g, '‡∏¥')
      .replace(/\u0E38/g, '‡∏∏')
      .replace(/\s+/g, ' ')
      .normalize('NFC')
      .trim();
  }

  function parseYMD(ymd){
    if(!ymd) return null;
    const parts = ymd.split("-");
    if(parts.length < 3) return null;
    return new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2]));
  }

  function getMonthRange(startStr, endStr){
    const [sy, sm] = startStr.split("-").map(Number);
    const [ey, em] = endStr.split("-").map(Number);
    const start = new Date(sy, sm - 1, 1);
    const end = new Date(ey, em, 1);
    return { start, end };
  }

  loadBtn.addEventListener("click", async ()=>{
    const sVal = startMonth.value;
    const eVal = endMonth.value;
    if(!sVal || !eVal){ 
      alert("‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö"); 
      return; 
    }

    const { start, end } = getMonthRange(sVal, eVal);
    if(start >= end){ 
      alert("‚ö†Ô∏è ‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á"); 
      return; 
    }

    loadBtn.disabled = true;
    exportBtn.disabled = true;
    tableWrap.innerHTML = "";
    showMessage("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà...", "loading");

    try{
      // Get events from RTDB
      const eventsRef = ref(db, 'events');
      const eventsSnapshot = await get(eventsRef);
      const events = [];
      
      if (eventsSnapshot.exists()) {
        const eventsData = eventsSnapshot.val();
        Object.entries(eventsData).forEach(([id, data]) => {
          events.push({ _id: id, ...data });
        });
      }

      // Get workers from RTDB
      const workersRef = ref(db, 'workers');
      const workersSnapshot = await get(workersRef);
      const workers = [];
      
      if (workersSnapshot.exists()) {
        const workersData = workersSnapshot.val();
        Object.values(workersData).forEach(data => {
          if (data.name) {
            workers.push(cleanText(data.name));
          }
        });
      }

      const mainStatuses = ["‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢", "‡πÑ‡∏°‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢", "‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥", "‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥"];
      
      const otherStatuses = new Set();
      events.forEach(ev => {
        if(ev.status && ev.status.trim() !== "") {
          const status = ev.status.trim();
          if(!mainStatuses.includes(status)) {
            otherStatuses.add(status);
          }
        }
      });

      const statusList = [...mainStatuses, ...Array.from(otherStatuses).sort((a,b) => a.localeCompare(b,"th"))];

      const stats = new Map();
      const ensureWorker = name => {
        if(!name) return;
        if(!stats.has(name)) {
          const workerStat = { name, total: 0 };
          statusList.forEach(status => { workerStat[status] = 0; });
          stats.set(name, workerStat);
        }
      };

      let totalEventsCount = 0;
      const totalStatusCount = {};
      statusList.forEach(status => { totalStatusCount[status] = 0; });

      if(includeZeroCheckbox.checked){
        workers.forEach(w => ensureWorker(w));
      }

      for(const ev of events){
        const startDate = parseYMD(ev.start);
        if(!startDate) continue;
        if(startDate >= start && startDate < end){

          totalEventsCount++;

          const workerList = Array.isArray(ev.workers) ? ev.workers : (ev.workers ? [ev.workers] : []);
          
          const status = ev.status ? ev.status.trim() : "";

          if(status && statusList.includes(status)) {
            totalStatusCount[status]++;
          }

          for(const w of workerList){
            const cleanedWorker = cleanText(w);
            ensureWorker(cleanedWorker);
            const rec = stats.get(cleanedWorker);
            rec.total++;
            if(status && statusList.includes(status)) {
              rec[status]++;
            }
          }
        }
      }

      const rows = Array.from(stats.values()).sort((a,b)=> a.name.localeCompare(b.name,"th"));
      if(rows.length === 0){
        tableWrap.innerHTML = `
          <div class="empty-state fade-in">
            <div class="empty-icon">üì≠</div>
            <h3>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h3>
            <p>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</p>
          </div>
        `;
        showMessage("‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å", "info");
        return;
      }

      const totalSum = { total: totalEventsCount };
      statusList.forEach(status => { 
        totalSum[status] = totalStatusCount[status];
      });

      const startThai = formatMonthThai(sVal);
      const endThai = formatMonthThai(eVal);

      let html = `<div class="results-card fade-in">`;
      
      html += `<div class="stats-summary">
        <div class="stat-card">
          <div class="stat-label">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
          <div class="stat-value">
            <span>üéØ</span>
            <span>${totalEventsCount}</span>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-label">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ö‡∏∏‡∏Ñ‡∏•‡∏≤‡∏Å‡∏£</div>
          <div class="stat-value">
            <span>üë•</span>
            <span>${rows.length}</span>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-label">‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢</div>
          <div class="stat-value">
            <span>‚úÖ</span>
            <span>${totalSum["‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢"] || 0}</span>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-label">‡πÑ‡∏°‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢</div>
          <div class="stat-value">
            <span>‚ö†Ô∏è</span>
            <span>${totalSum["‡πÑ‡∏°‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢"] || 0}</span>
          </div>
        </div>
      </div>`;

      html += `<div class="table-wrapper">
        <table>
          <thead>
            <tr>
              <th>‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô</th>
              <th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</th>
              <th>‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢</th>
              <th>‡πÑ‡∏°‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢</th>
              <th>‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</th>
              <th>‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</th>
            </tr>
          </thead>
          <tbody>`;

      rows.forEach(r=>{
        html += `<tr>
          <td><strong>${r.name}</strong></td>
          <td><strong>${r.total}</strong></td>
          <td>${r["‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢"] || 0}</td>
          <td>${r["‡πÑ‡∏°‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢"] || 0}</td>
          <td>${r["‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥"] || 0}</td>
          <td>${r["‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥"] || 0}</td>
        </tr>`;
      });

      html += `</tbody></table></div>`;

      html += `<div class="summary-section">
        <div class="summary-title">
          <span>üìä</span>
          <span>‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏£‡∏ß‡∏°‡∏£‡∏≤‡∏¢‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•</span>
        </div>
        <ul class="summary-list">`;
      
      rows.forEach(r=>{
        let details = statusList.map(s => `${s} ${r[s]}`).join(", ");
        html += `
          <li class="summary-item">
            <strong>${r.name}</strong>
            <div class="summary-details">‡∏£‡∏ß‡∏° ${r.total} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á (${details})</div>
          </li>`;
      });
      
      html += `</ul></div></div>`;

      tableWrap.innerHTML = html;
      showMessage(`‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏£‡∏ß‡∏°‡∏ä‡πà‡∏ß‡∏á ${startThai} ‡∏ñ‡∏∂‡∏á ${endThai}`, "success");

      exportBtn.disabled = false;
      currentReport = { rows, totalSum, totalEventsCount, sVal, eVal, statusList, startThai, endThai };

    }catch(err){
      console.error(err);
      alert("‚ö†Ô∏è ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•");
      showMessage("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•", "info");
    }finally{
      loadBtn.disabled = false;
    }
  });

  exportBtn.addEventListener("click", ()=>{
    if(!currentReport?.rows?.length) return alert("‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ export");

    const { rows, totalSum, totalEventsCount, sVal, eVal, statusList, startThai, endThai } = currentReport;

    const header = ["‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏î‡∏∑‡∏≠‡∏ô","‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô","‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î","‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢","‡πÑ‡∏°‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢","‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥","‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥"];
    
    const lines = [header.join(",")];

    rows.forEach(r=>{
      const row = [
        `"${startThai} ‡∏ñ‡∏∂‡∏á ${endThai}"`,
        `"${cleanText(r.name)}"`,
        r.total,
        r["‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢"] || 0,
        r["‡πÑ‡∏°‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢"] || 0,
        r["‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥"] || 0,
        r["‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥"] || 0
      ];
      lines.push(row.join(","));
    });

    const totalRow = [
      "\"‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î\"",
      "",
      totalSum.total,
      totalSum["‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢"] || 0,
      totalSum["‡πÑ‡∏°‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢"] || 0,
      totalSum["‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥"] || 0,
      totalSum["‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥"] || 0
    ];
    lines.push(totalRow.join(","));

    lines.push("");
    lines.push(`‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡∏ô‡∏±‡∏ö‡∏ï‡∏≤‡∏°‡∏à‡∏≥‡∏ô‡∏ß‡∏ô event),${totalEventsCount}`);
    lines.push("");

    lines.push("üìà ‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î");
    lines.push(`‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏î‡∏∑‡∏≠‡∏ô,"${startThai} ‡∏ñ‡∏∂‡∏á ${endThai}"`);
    lines.push(`‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î,${totalSum.total}`);
    lines.push(`‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢,${totalSum["‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢"] || 0}`);
    lines.push(`‡πÑ‡∏°‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢,${totalSum["‡πÑ‡∏°‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢"] || 0}`);
    lines.push(`‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥,${totalSum["‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥"] || 0}`);
    lines.push(`‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥,${totalSum["‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥"] || 0}`);

    const csv = "\uFEFF" + lines.join("\n");
    const blob = new Blob([csv], {type:"text/csv;charset=utf-8;"});
    const url = URL.createObjectURL(blob);

    const a = document.createElement("a");
    a.href = url;
    a.download = `‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô-${startThai}_‡∏ñ‡∏∂‡∏á_${endThai}.csv`;
    a.click();

    URL.revokeObjectURL(url);
    
    showMessage("‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå CSV ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!", "success");
  });

  showMessage("‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î \"‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•\"", "info");
</script>

</body>
</html>