<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô AUTODIDACTIC</title>
<link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;600;700&display=swap" rel="stylesheet">
<style>
/* ===== Variables ===== */
:root {
  --primary-color: #c00;
  --primary-dark: #a00;
  --primary-light: #fee;
  --secondary-color: #444;
  --success-color: #28a745;
  --warning-color: #ffc107;
  --danger-color: #dc3545;
  --text-dark: #333;
  --border-radius: 12px;
  --shadow: 0 4px 12px rgba(0,0,0,0.08);
  --shadow-hover: 0 6px 20px rgba(0,0,0,0.12);
}

/* ===== General Theme ===== */
* {
  box-sizing: border-box;
}

body {
  font-family: 'Prompt', sans-serif;
  background: linear-gradient(135deg, #fff 0%, #fee 100%);
  color: var(--text-dark);
  margin: 0;
  min-height: 100vh;
  display: flex;
  flex-direction: column;
}

/* ===== Header ===== */
header {
  background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
  color: #fff;
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 16px 24px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
  position: sticky;
  top: 0;
  z-index: 100;
}

.logo-container {
  display: flex;
  align-items: center;
  background: rgba(255,255,255,0.95);
  padding: 8px 12px;
  border-radius: 10px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.logo-container img { 
  width: 45px; 
  height: auto;
}

header h1 {
  flex: 1;
  text-align: center;
  font-size: 22px;
  font-weight: 700;
  margin: 0;
  text-shadow: 0 2px 4px rgba(0,0,0,0.2);
}

header nav a {
  color: #fff;
  background: rgba(255,255,255,0.2);
  padding: 10px 18px;
  border-radius: 8px;
  font-weight: 600;
  text-decoration: none;
  transition: all 0.3s ease;
  border: 2px solid transparent;
}

header nav a:hover { 
  background: rgba(255,255,255,0.3);
  border-color: rgba(255,255,255,0.5);
  transform: translateY(-2px);
}

/* ===== Main Layout ===== */
main {
  flex: 1;
  display: grid;
  grid-template-columns: minmax(400px, 1fr) 350px 350px;
  gap: 24px;
  padding: 24px;
  max-width: 1600px;
  margin: 0 auto;
  width: 100%;
}

/* ===== Form Panel ===== */
.form-container {
  background: #fff;
  border-radius: var(--border-radius);
  padding: 32px;
  box-shadow: var(--shadow);
  transition: all 0.3s ease;
  height: fit-content;
  max-height: calc(100vh - 150px);
  overflow-y: auto;
}

.form-container:hover { 
  box-shadow: var(--shadow-hover);
}

.form-header {
  text-align: center;
  margin-bottom: 28px;
  padding-bottom: 20px;
  border-bottom: 3px solid var(--primary-light);
}

.form-header h2 {
  color: var(--primary-color);
  margin: 0;
  font-size: 26px;
  font-weight: 700;
}

.form-header p {
  color: #666;
  margin: 8px 0 0 0;
  font-size: 14px;
}

/* ===== Form Groups ===== */
.form-group {
  margin-bottom: 20px;
}

.form-group label {
  display: block;
  font-weight: 600;
  color: var(--text-dark);
  margin-bottom: 8px;
  font-size: 15px;
}

.form-group label .required {
  color: var(--danger-color);
  margin-left: 4px;
}

.form-group .help-text {
  font-size: 13px;
  color: #666;
  margin-top: 4px;
  font-style: italic;
}

/* ===== Inputs ===== */
.input-line {
  width: 100%;
  padding: 12px 14px;
  border: 2px solid #ddd;
  border-radius: 8px;
  outline: none;
  font-size: 15px;
  color: var(--text-dark);
  background: #fff;
  transition: all 0.3s ease;
  font-family: 'Prompt', sans-serif;
}

.input-line:focus { 
  border-color: var(--primary-color);
  box-shadow: 0 0 0 3px rgba(204,0,0,0.1);
}

.input-line:disabled {
  background: #f5f5f5;
  cursor: not-allowed;
  color: #666;
}

.input-line::placeholder {
  color: #999;
}

textarea.input-line { 
  height: 100px;
  resize: vertical;
  min-height: 80px;
}

/* ===== Checkbox Group ===== */
.checkbox-group {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
  gap: 12px;
  padding: 16px;
  background: #f9f9f9;
  border-radius: 8px;
  border: 2px solid #eee;
}

.checkbox-group label {
  display: flex;
  align-items: center;
  gap: 8px;
  font-weight: 400;
  cursor: pointer;
  padding: 8px;
  border-radius: 6px;
  transition: all 0.2s ease;
}

.checkbox-group label:hover {
  background: #fff;
}

.checkbox-group input[type="checkbox"] {
  width: 18px;
  height: 18px;
  cursor: pointer;
  accent-color: var(--primary-color);
}

.other-input-wrapper {
  display: flex;
  align-items: center;
  gap: 8px;
  flex-wrap: wrap;
}

.other-input-wrapper input[type="text"] {
  flex: 1;
  min-width: 120px;
  padding: 6px 10px;
  border: 2px solid #ddd;
  border-radius: 6px;
  font-size: 14px;
}

/* ===== Urgent Job Checkbox ===== */
.urgent-checkbox {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 14px 18px;
  background: linear-gradient(135deg, #fff3cd 0%, #ffe69c 100%);
  border: 2px solid var(--warning-color);
  border-radius: 8px;
  cursor: pointer;
  transition: all 0.3s ease;
  margin: 20px 0;
}

.urgent-checkbox:hover {
  transform: translateX(4px);
  box-shadow: 0 4px 12px rgba(255,193,7,0.3);
}

.urgent-checkbox input[type="checkbox"] {
  width: 20px;
  height: 20px;
  cursor: pointer;
  accent-color: #ff6b00;
}

.urgent-checkbox span {
  font-weight: 600;
  color: #856404;
  font-size: 16px;
}

/* ===== Buttons ===== */
button {
  width: 100%;
  padding: 14px;
  margin-top: 8px;
  border-radius: 8px;
  background: var(--primary-color);
  color: #fff;
  font-weight: 600;
  border: none;
  cursor: pointer;
  font-size: 16px;
  transition: all 0.3s ease;
  box-shadow: 0 4px 12px rgba(204,0,0,0.2);
  font-family: 'Prompt', sans-serif;
}

button:hover { 
  background: var(--primary-dark);
  transform: translateY(-2px);
  box-shadow: 0 6px 16px rgba(204,0,0,0.3);
}

button:active {
  transform: translateY(0);
}

.btn-back {
  display: inline-block;
  margin-top: 12px;
  text-align: center;
  background: #6c757d;
  color: #fff;
  padding: 12px 20px;
  border-radius: 8px;
  text-decoration: none;
  font-weight: 600;
  transition: all 0.3s ease;
  box-shadow: 0 4px 12px rgba(108,117,125,0.2);
}

.btn-back:hover { 
  background: #5a6268;
  transform: translateY(-2px);
}

/* ===== Side Panels ===== */
.panel {
  background: #fff;
  border-radius: var(--border-radius);
  padding: 24px;
  box-shadow: var(--shadow);
  max-height: calc(100vh - 150px);
  overflow-y: auto;
  display: flex;
  flex-direction: column;
}

.panel-header {
  display: flex;
  align-items: center;
  gap: 10px;
  margin-bottom: 20px;
  padding-bottom: 16px;
  border-bottom: 3px solid var(--primary-light);
}

.panel-header h3 {
  margin: 0;
  font-size: 20px;
  font-weight: 700;
  color: var(--primary-color);
  flex: 1;
}

.panel-header .count-badge {
  background: var(--primary-color);
  color: #fff;
  padding: 4px 12px;
  border-radius: 12px;
  font-size: 14px;
  font-weight: 600;
}

.completed-panel .panel-header h3 {
  color: var(--success-color);
}

.completed-panel .panel-header .count-badge {
  background: var(--success-color);
}

/* ===== Event Items ===== */
.event-list {
  display: flex;
  flex-direction: column;
  gap: 16px;
}

.event-item {
  border: 2px solid #e0e0e0;
  border-radius: 10px;
  padding: 16px;
  background: #fff;
  transition: all 0.3s ease;
  position: relative;
  overflow: hidden;
}

.event-item::before {
  content: "";
  position: absolute;
  left: 0;
  top: 0;
  bottom: 0;
  width: 4px;
  background: var(--primary-color);
}

.event-item:hover {
  box-shadow: 0 6px 16px rgba(0,0,0,0.1);
  transform: translateX(4px);
}

.event-item strong {
  display: inline-block;
  font-size: 16px;
  color: var(--primary-color);
  margin-bottom: 8px;
}

.event-item-row {
  display: flex;
  align-items: flex-start;
  gap: 8px;
  margin: 6px 0;
  font-size: 14px;
  line-height: 1.6;
}

.event-item-row .icon {
  flex-shrink: 0;
  width: 20px;
}

.status-badge {
  display: inline-block;
  padding: 4px 12px;
  border-radius: 12px;
  font-size: 13px;
  font-weight: 600;
  margin-left: 8px;
}

.status-pending {
  background: #fff3cd;
  color: #856404;
}

.status-approved {
  background: #d4edda;
  color: #155724;
}

.status-urgent {
  background: #f8d7da;
  color: #721c24;
  animation: pulse 2s infinite;
}

@keyframes pulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.7; }
}

/* ===== Event Actions ===== */
.event-actions {
  display: flex;
  gap: 8px;
  margin-top: 12px;
  padding-top: 12px;
  border-top: 1px solid #eee;
  flex-wrap: wrap;
}

.event-actions button {
  width: auto;
  padding: 8px 16px;
  margin: 0;
  font-size: 14px;
  flex: 1;
  min-width: 80px;
}

.print-btn { 
  background: var(--secondary-color);
  box-shadow: 0 2px 8px rgba(68,68,68,0.2);
}

.print-btn:hover { 
  background: #2c2c2c;
}

.edit-btn { 
  background: #007bff;
  box-shadow: 0 2px 8px rgba(0,123,255,0.2);
}

.edit-btn:hover { 
  background: #0056b3;
}

.delete-btn { 
  background: var(--danger-color);
  box-shadow: 0 2px 8px rgba(220,53,69,0.2);
}

.delete-btn:hover { 
  background: #c82333;
}

/* ===== Empty State ===== */
.empty-state {
  text-align: center;
  padding: 40px 20px;
  color: #999;
}

.empty-state .icon {
  font-size: 48px;
  margin-bottom: 16px;
  opacity: 0.5;
}

.empty-state p {
  font-size: 16px;
  margin: 0;
}

/* ===== Footer ===== */
footer {
  background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
  color: #fff;
  text-align: center;
  padding: 16px;
  font-size: 14px;
  box-shadow: 0 -4px 12px rgba(0,0,0,0.1);
  margin-top: auto;
}

/* ===== Scrollbar Styling ===== */
::-webkit-scrollbar {
  width: 8px;
  height: 8px;
}

::-webkit-scrollbar-track {
  background: #f1f1f1;
  border-radius: 4px;
}

::-webkit-scrollbar-thumb {
  background: var(--primary-color);
  border-radius: 4px;
}

::-webkit-scrollbar-thumb:hover {
  background: var(--primary-dark);
}

/* ===== Responsive Design ===== */
@media(max-width: 1200px) {
  main {
    grid-template-columns: 1fr 1fr;
  }
  
  .form-container {
    grid-column: 1 / -1;
  }
}

@media(max-width: 768px) {
  main {
    grid-template-columns: 1fr;
    padding: 16px;
    gap: 16px;
  }
  
  header {
    flex-wrap: wrap;
    gap: 12px;
    padding: 12px 16px;
  }
  
  header h1 {
    font-size: 18px;
    width: 100%;
    order: 2;
  }
  
  .logo-container {
    order: 1;
  }
  
  header nav {
    order: 3;
  }
  
  .checkbox-group {
    grid-template-columns: 1fr;
  }
  
  .form-container,
  .panel {
    padding: 20px;
    max-height: none;
  }
  
  .event-actions {
    flex-direction: column;
  }
  
  .event-actions button {
    width: 100%;
  }
}

@media(max-width: 480px) {
  header h1 {
    font-size: 16px;
  }
  
  .form-header h2 {
    font-size: 22px;
  }
  
  .input-line {
    font-size: 14px;
    padding: 10px 12px;
  }
  
  button {
    font-size: 14px;
    padding: 12px;
  }
}
/* ====== Custom Alert Overlay ====== */
.custom-alert-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.8);
  backdrop-filter: blur(10px);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 9999;
  animation: fadeIn 0.3s ease;
}

.custom-alert-box {
  background: #fff;
  padding: 2.5rem;
  border-radius: 20px;
  text-align: center;
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
  max-width: 400px;
  animation: slideUp 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
}

.custom-alert-icon {
  font-size: 4rem;
  margin-bottom: 1rem;
  animation: bounce 0.6s ease;
}

.custom-alert-title {
  background: linear-gradient(135deg, #c00 0%, #f44336 100%);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  margin-bottom: 1rem;
  font-size: 1.75rem;
  font-weight: 700;
}

.custom-alert-message {
  font-size: 1.1rem;
  color: #4a5568;
  margin-bottom: 1rem;
  line-height: 1.6;
}

.custom-alert-redirect {
  font-size: 0.9rem;
  color: #718096;
  margin-top: 1rem;
}

.custom-alert-progress {
  width: 100%;
  height: 4px;
  background: rgba(192, 0, 0, 0.2);
  border-radius: 2px;
  margin-top: 1.5rem;
  overflow: hidden;
}

.custom-alert-progress-bar {
  height: 100%;
  background: linear-gradient(135deg, #c00 0%, #f44336 100%);
  animation: progressBar 3s linear;
  border-radius: 2px;
}

@keyframes bounce {
  0%, 100% { transform: translateY(0); }
  50% { transform: translateY(-10px); }
}

@keyframes progressBar {
  from { width: 0%; }
  to { width: 100%; }
}
</style>
</head>

<body>

<header>
  <div class="logo-container">
    <img src="ad_logo-Photoroom.png" alt="Logo">
  </div>
  <h1>üìã ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô AUTODIDACTIC</h1>
  <nav><a href="#" id="backToCalendarLink">‚Üê ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô</a></nav>
</header>

<main>
  <!-- ========== FORM ========== -->
  <div class="form-container">
    <div class="form-header">
      <h2 id="formTitle">‚ú® ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà</h2>
      <p>‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡πà‡∏á‡∏Ç‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</p>
    </div>
    
    <form id="eventForm">
      <input type="hidden" id="eventId">
      <input type="hidden" id="assignedByValue">
      <input type="hidden" id="positionValue">

      <div class="form-group">
        <label>üìù ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏á‡∏≤‡∏ô:</label>
        <input type="text" id="jobNumber" class="input-line" placeholder="‡πÄ‡∏ä‡πà‡∏ô JOB-001 (‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö)">
        <div class="help-text">‡∏´‡∏≤‡∏Å‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏ ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</div>
      </div>

      <div class="form-group">
        <label>üë§ ‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏±‡πà‡∏á‡∏á‡∏≤‡∏ô: <span class="required">*</span></label>
        <input type="text" id="assignedByDisplay" class="input-line" placeholder="‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•..." disabled>
        <div class="help-text">‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏î‡∏∂‡∏á‡∏à‡∏≤‡∏Å URL ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</div>
      </div>

      <div class="form-group">
        <label>üíº ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á: <span class="required">*</span></label>
        <input type="text" id="positionDisplay" class="input-line" placeholder="‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•..." disabled>
        <div class="help-text">‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏î‡∏∂‡∏á‡∏à‡∏≤‡∏Å URL ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</div>
      </div>

      <div class="form-group">
        <label>üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏±‡πà‡∏á‡∏á‡∏≤‡∏ô: <span class="required">*</span></label>
        <input type="date" id="orderDate" class="input-line" required>
      </div>

      <div class="form-group">
        <label>üöÄ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°: <span class="required">*</span></label>
        <input type="date" id="start" class="input-line" required>
      </div>

      <div class="form-group">
        <label>üèÅ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î: <span class="required">*</span></label>
        <input type="date" id="end" class="input-line" required>
      </div>

      <div class="form-group">
        <label>üìç ‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà: <span class="required">*</span></label>
        <input type="text" id="location" class="input-line" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô" required>
      </div>

      <div class="form-group">
        <label>üè∑Ô∏è ‡∏•‡∏±‡∏Å‡∏©‡∏ì‡∏∞‡∏á‡∏≤‡∏ô: <span class="required">*</span></label>
        <div id="jobTypeGroup" class="checkbox-group">
          <label><input type="checkbox" value="‡∏™‡πà‡∏á‡∏°‡∏≠‡∏ö"> ‡∏™‡πà‡∏á‡∏°‡∏≠‡∏ö</label>
          <label><input type="checkbox" value="‡∏ù‡∏∂‡∏Å‡∏≠‡∏ö‡∏£‡∏°"> ‡∏ù‡∏∂‡∏Å‡∏≠‡∏ö‡∏£‡∏°</label>
          <label><input type="checkbox" value="‡∏≠‡∏≠‡∏Å‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤"> ‡∏≠‡∏≠‡∏Å‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</label>
          <label><input type="checkbox" value="‡∏ï‡∏£‡∏ß‡∏à‡πÄ‡∏ä‡πá‡∏Ñ/‡∏ã‡πà‡∏≠‡∏°"> ‡∏ï‡∏£‡∏ß‡∏à‡πÄ‡∏ä‡πá‡∏Ñ/‡∏ã‡πà‡∏≠‡∏°</label>
          <label><input type="checkbox" value="Visit"> Visit</label>
          <label class="other-input-wrapper">
            <input type="checkbox" id="otherJobTypeCheck" value="‡∏≠‡∏∑‡πà‡∏ô‡πÜ"> ‡∏≠‡∏∑‡πà‡∏ô‡πÜ:
            <input type="text" id="otherJobTypeText" placeholder="‡∏£‡∏∞‡∏ö‡∏∏...">
          </label>
        </div>
      </div>

      <label class="urgent-checkbox">
        <input type="checkbox" id="urgentJob">
        <span>‚ö° ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô‡∏î‡πà‡∏ß‡∏ô</span>
      </label>

      <div class="form-group">
        <label>üìÑ ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏á‡∏≤‡∏ô: <span class="required">*</span></label>
        <textarea id="details" class="input-line" placeholder="‡πÉ‡∏™‡πà‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏á‡∏≤‡∏ô..." required></textarea>
      </div>

      <div class="form-group">
        <label>üë®‚Äçüíº ‡∏ú‡∏π‡πâ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠: <span class="required">*</span></label>
        <input type="text" id="contactPerson" class="input-line" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠" required>
      </div>

      <div class="form-group">
        <label>üìû ‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå: <span class="required">*</span></label>
        <input type="tel" id="phoneNumber" class="input-line" placeholder="‡πÄ‡∏ä‡πà‡∏ô 0812345678" required>
      </div>

      <button type="submit">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏á‡∏≤‡∏ô</button>
      <a href="#" class="btn-back" id="backToCalendarBtn">‚Üê ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô</a>
    </form>
  </div>

  <!-- ========== ACTIVE EVENT LIST ========== -->
  <div class="panel">
    <div class="panel-header">
      <h3>üîÑ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</h3>
      <span class="count-badge" id="activeCount">0</span>
    </div>
    <div class="event-list" id="eventList">
      <div class="empty-state">
        <div class="icon">üìã</div>
        <p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</p>
      </div>
    </div>
  </div>

  <!-- ========== COMPLETED EVENT LIST ========== -->
  <div class="panel completed-panel">
    <div class="panel-header">
      <h3>‚úÖ ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß</h3>
      <span class="count-badge" id="completedCount">0</span>
    </div>
    <div class="event-list" id="completedEventList">
      <div class="empty-state">
        <div class="icon">‚úì</div>
        <p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô</p>
      </div>
    </div>
  </div>
</main>

<footer>
  ¬© 2025 AUTODIDACTIC SYSTEM - All Rights Reserved
</footer>

<!-- ========== SCRIPT SECTION ========== -->

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
import { getDatabase, ref, get, set, push, remove, update, child } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyABY8jkjB2RD3RPK-qQ6kJThm32Pc9OpKE",
  authDomain: "events-93cb9.firebaseapp.com",
  databaseURL: "https://events-93cb9-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "events-93cb9",
  storageBucket: "events-93cb9.firebasestorage.app",
  messagingSenderId: "234410411694",
  appId: "1:234410411694:web:b544058bce0dfe78a88f3f",
  measurementId: "G-4D3X216R1K"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

// ‚úÖ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô Encode/Decode ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏≠‡πà‡∏≠‡∏ô (‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏ó‡∏∏‡∏Å‡∏†‡∏≤‡∏©‡∏≤)
function encodeData(text) {
  if (!text) return "";
  try {
    return btoa(unescape(encodeURIComponent(text)));
  } catch (error) {
    console.error("Error encoding data:", error);
    return text;
  }
}

function decodeData(encodedText) {
  if (!encodedText) return "";
  
  try {
    let decoded = decodeURIComponent(escape(atob(encodedText)));
    if (decoded.includes('%')) {
      decoded = decodeURIComponent(decoded);
    }
    return decoded;
  } catch (error) {
    try {
      if (encodedText.includes('%')) {
        return decodeURIComponent(encodedText);
      }
    } catch (e) {
      console.error("‚ö†Ô∏è Error decoding:", e);
    }
    return encodedText;
  }
}

// ‚úÖ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á URL ‡∏û‡∏£‡πâ‡∏≠‡∏° position parameter
function buildCalendarURL() {
  const name = sessionStorage.getItem("assignedByName") || "";
  const position = sessionStorage.getItem("assignedByPosition") || "";
  
  let url = "calendar_admin.html";
  const params = new URLSearchParams();
  
  if (name) params.set("name", name);
  if (position) params.set("position", position);
  
  if (params.toString()) {
    url += "?" + params.toString();
  }
  
  console.log("üîó ‡∏™‡∏£‡πâ‡∏≤‡∏á URL ‡∏Å‡∏•‡∏±‡∏ö‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô:", url);
  return url;
}

// ‚úÖ ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏Å‡∏•‡∏±‡∏ö‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô‡πÉ‡∏´‡πâ‡∏°‡∏µ position
function setupBackLinks() {
  const calendarURL = buildCalendarURL();
  
  document.getElementById("backToCalendarLink").href = calendarURL;
  document.getElementById("backToCalendarBtn").href = calendarURL;
  
  console.log("‚úÖ ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏Å‡∏•‡∏±‡∏ö‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö DD/MM/YYYY (‡∏û.‡∏®.)
function formatDateThai(dateStr) {
  if (!dateStr) return "-";
  const [year, month, day] = dateStr.split("-");
  const buddhistYear = parseInt(year) + 543;
  return `${day}/${month}/${buddhistYear}`;
}

const today = new Date().toISOString().split("T")[0];
document.getElementById("orderDate").value = today;

const eventList = document.getElementById("eventList");
const completedEventList = document.getElementById("completedEventList");

// ‚úÖ ‡∏î‡∏∂‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡∏∞‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏à‡∏≤‡∏Å URL ‡∏´‡∏£‡∏∑‡∏≠ sessionStorage
function getDataFromURL() {
  const urlParams = new URLSearchParams(window.location.search);
  let nameFromURL = urlParams.get('name');
  let positionFromURL = urlParams.get('position');
  
  if (nameFromURL) {
    nameFromURL = nameFromURL.trim().normalize('NFC');
    sessionStorage.setItem("assignedByName", nameFromURL);
    document.getElementById("assignedByDisplay").value = nameFromURL;
    document.getElementById("assignedByValue").value = nameFromURL;
    console.log("‚úÖ ‡∏î‡∏∂‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏≤‡∏Å URL ‡πÅ‡∏•‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß:", nameFromURL);
  } else {
    const savedName = sessionStorage.getItem("assignedByName");
    if (savedName) {
      document.getElementById("assignedByDisplay").value = savedName;
      document.getElementById("assignedByValue").value = savedName;
      console.log("‚úÖ ‡∏î‡∏∂‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏≤‡∏Å sessionStorage:", savedName);
    } else {
      document.getElementById("assignedByDisplay").value = "‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏ô URL";
      console.warn("‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏û‡∏ö parameter 'name' ‡πÉ‡∏ô URL ‡πÅ‡∏•‡∏∞ sessionStorage");
    }
  }

  if (positionFromURL) {
    positionFromURL = positionFromURL.trim().normalize('NFC');
    sessionStorage.setItem("assignedByPosition", positionFromURL);
    document.getElementById("positionDisplay").value = positionFromURL;
    document.getElementById("positionValue").value = positionFromURL;
    console.log("‚úÖ ‡∏î‡∏∂‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏à‡∏≤‡∏Å URL ‡πÅ‡∏•‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß:", positionFromURL);
  } else {
    const savedPosition = sessionStorage.getItem("assignedByPosition");
    if (savedPosition) {
      document.getElementById("positionDisplay").value = savedPosition;
      document.getElementById("positionValue").value = savedPosition;
      console.log("‚úÖ ‡∏î‡∏∂‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏à‡∏≤‡∏Å sessionStorage:", savedPosition);
    } else {
      document.getElementById("positionDisplay").value = "‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÉ‡∏ô URL";
      console.warn("‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏û‡∏ö parameter 'position' ‡πÉ‡∏ô URL ‡πÅ‡∏•‡∏∞ sessionStorage");
    }
  }
  
  // ‚úÖ ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡πâ‡∏ß
  setupBackLinks();
}

async function loadEvents() {
  eventList.innerHTML = "";
  completedEventList.innerHTML = "";
  
  const currentUser = sessionStorage.getItem("userName");
  
  if (!currentUser) {
    eventList.innerHTML = '<div class="empty-state"><div class="icon">‚ö†Ô∏è</div><p>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤ Login ‡∏Å‡πà‡∏≠‡∏ô‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</p></div>';
    completedEventList.innerHTML = '<div class="empty-state"><div class="icon">‚ö†Ô∏è</div><p>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤ Login ‡∏Å‡πà‡∏≠‡∏ô‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</p></div>';
    return;
  }
  
  const normalizedCurrentUser = currentUser.trim().normalize('NFC');
  console.log("üë§ ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô:", normalizedCurrentUser);
  
  const eventsRef = ref(db, "events");
  const snapshot = await get(eventsRef);
  
  if (!snapshot.exists()) {
    eventList.innerHTML = '<div class="empty-state"><div class="icon">üìã</div><p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</p></div>';
    completedEventList.innerHTML = '<div class="empty-state"><div class="icon">‚úì</div><p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô</p></div>';
    return;
  }
  
  const events = snapshot.val();
  let activeCount = 0;
  let completedCount = 0;
  
  Object.keys(events).forEach(eventId => {
    const data = events[eventId];
    const isFinished = data.status === "‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢" || data.status === "‡πÑ‡∏°‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢";
    
    let assigners = [];
    if (Array.isArray(data.assigners)) {
      assigners = data.assigners.map(name => name.trim().normalize('NFC'));
    } else if (typeof data.assigners === 'string') {
      assigners = data.assigners.split(',').map(name => name.trim().normalize('NFC'));
    }
    
    if (!assigners.includes(normalizedCurrentUser)) {
      return;
    }
    
    const div = document.createElement("div");
    div.className = "event-item";
    const isApproved = data.status === "‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥" || data.status === "‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏î‡πà‡∏ß‡∏ô";
    const isPending = data.status === "‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥" || data.status === "‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏î‡πà‡∏ß‡∏ô";
    const isUrgent = data.status?.includes("‡∏î‡πà‡∏ß‡∏ô");

    let buttonsHTML = "";
    let statusBadge = "";
    
    if (isPending) {
      statusBadge = `<span class="status-badge ${isUrgent ? 'status-urgent' : 'status-pending'}">${data.status || "‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥"}</span>`;
    } else if (isApproved) {
      statusBadge = `<span class="status-badge status-approved">${data.status}</span>`;
    } else if (isFinished) {
      statusBadge = `<span class="status-badge status-approved">${data.status}</span>`;
    }
    
    if (isFinished) {
      completedCount++;
      buttonsHTML = `
        <div class="event-actions">
          <button class="print-btn" onclick="printEvent('${eventId}')">üñ® ‡∏û‡∏¥‡∏°‡∏û‡πå</button>
        </div>`;
    } else if (isPending) {
      activeCount++;
      buttonsHTML = `
        <div class="event-actions">
          <button class="edit-btn" onclick="editEvent('${eventId}')">‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
          <button class="delete-btn" onclick="deleteEvent('${eventId}')">üóëÔ∏è ‡∏•‡∏ö</button>
          <button class="print-btn" onclick="printEvent('${eventId}')">üñ® ‡∏û‡∏¥‡∏°‡∏û‡πå</button>
        </div>`;
    } else if (isApproved) {
      activeCount++;
      buttonsHTML = `
        <div class="event-actions">
          <button class="print-btn" onclick="printEvent('${eventId}')">üñ® ‡∏û‡∏¥‡∏°‡∏û‡πå</button>
        </div>`;
    }
    
    const positionDisplay = data.assignerPositions && data.assignerPositions.length > 0 
      ? `<div class="event-item-row">
          <span class="icon">üíº</span>
          <span>‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á: ${data.assignerPositions.join(", ")}</span>
        </div>` 
      : '';
    
    div.innerHTML = `
      <strong>${data.jobNumber || "‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏"}</strong>
      <div class="event-item-row">
        <span class="icon">üìç</span>
        <span>${data.location}</span>
      </div>
      <div class="event-item-row">
        <span class="icon">üìÖ</span>
        <span>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏±‡πà‡∏á‡∏á‡∏≤‡∏ô: ${formatDateThai(data.orderDate)}</span>
      </div>
      <div class="event-item-row">
        <span class="icon">üöÄ</span>
        <span>${formatDateThai(data.start)} ‚Üí ${formatDateThai(data.end)}</span>
      </div>
      <div class="event-item-row">
        <span class="icon">üë§</span>
        <span>${decodeData(data.contactPerson) || "-"} (${decodeData(data.phoneNumber) || "-"})</span>
      </div>
      <div class="event-item-row">
        <span class="icon">üè∑Ô∏è</span>
        <span>${(data.jobTypes || []).join(", ")}</span>
      </div>
      <div class="event-item-row">
        <span class="icon">üßë</span>
        <span>‡∏ú‡∏π‡πâ‡∏™‡∏±‡πà‡∏á: ${(data.assigners || []).join(", ")}</span>
      </div>
      ${positionDisplay}
      <div class="event-item-row">
        <span class="icon">üìå</span>
        <span>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ${statusBadge}</span>
      </div>
      ${data.incompleteReason ? `<div class="event-item-row"><span class="icon">‚ö†Ô∏è</span><span>‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•: ${data.incompleteReason}</span></div>` : ''}
      ${buttonsHTML}`;
    
    if (isFinished) {
      completedEventList.appendChild(div);
    } else {
      eventList.appendChild(div);
    }
  });
  
  document.getElementById("activeCount").textContent = activeCount;
  document.getElementById("completedCount").textContent = completedCount;
  
  if (activeCount === 0) {
    eventList.innerHTML = '<div class="empty-state"><div class="icon">üìã</div><p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</p></div>';
  }
  
  if (completedCount === 0) {
    completedEventList.innerHTML = '<div class="empty-state"><div class="icon">‚úì</div><p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô</p></div>';
  }
}

window.deleteEvent = async id => {
  if (confirm("‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?")) {
    await remove(ref(db, `events/${id}`));
    await loadEvents();
  }
}

window.editEvent = async id => {
  const eventRef = ref(db, `events/${id}`);
  const snapshot = await get(eventRef);
  
  if (!snapshot.exists()) {
    alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•");
    return;
  }
  
  const data = snapshot.val();
  if (data.status === "‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥" || data.status === "‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏î‡πà‡∏ß‡∏ô") {
    alert("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß‡πÑ‡∏î‡πâ");
    return;
  }

  document.getElementById("eventId").value = id;
  document.getElementById("jobNumber").value = data.jobNumber || "";
  document.getElementById("location").value = data.location;
  document.getElementById("details").value = data.details;
  document.getElementById("orderDate").value = data.orderDate || "";
  document.getElementById("start").value = data.start;
  document.getElementById("end").value = data.end;
  document.getElementById("contactPerson").value = decodeData(data.contactPerson) || "";
  document.getElementById("phoneNumber").value = decodeData(data.phoneNumber) || "";
  document.getElementById("urgentJob").checked = data.isUrgent || false;

  if (data.assigners && data.assigners.length > 0) {
    const assignerName = Array.isArray(data.assigners) ? data.assigners[0] : data.assigners;
    document.getElementById("assignedByDisplay").value = assignerName;
    document.getElementById("assignedByValue").value = assignerName;
  }

  if (data.assignerPositions && data.assignerPositions.length > 0) {
    const assignerPosition = Array.isArray(data.assignerPositions) ? data.assignerPositions[0] : data.assignerPositions;
    document.getElementById("positionDisplay").value = assignerPosition;
    document.getElementById("positionValue").value = assignerPosition;
  }

  document.querySelectorAll("#jobTypeGroup input[type=checkbox]").forEach(cb => cb.checked = false);
  document.getElementById("otherJobTypeText").value = "";

  if (data.jobTypes) {
    document.querySelectorAll("#jobTypeGroup input[type=checkbox]").forEach(cb => {
      if (data.jobTypes.includes(cb.value)) cb.checked = true;
    });
    const other = data.jobTypes.find(t => !["‡∏™‡πà‡∏á‡∏°‡∏≠‡∏ö","‡∏ù‡∏∂‡∏Å‡∏≠‡∏ö‡∏£‡∏°","‡∏≠‡∏≠‡∏Å‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤","‡∏ï‡∏£‡∏ß‡∏à‡πÄ‡∏ä‡πá‡∏Ñ/‡∏ã‡πà‡∏≠‡∏°","Visit","‡∏≠‡∏∑‡πà‡∏ô‡πÜ"].includes(t));
    if (other) {
      document.getElementById("otherJobTypeCheck").checked = true;
      document.getElementById("otherJobTypeText").value = other;
    }
  }

  document.getElementById("formTitle").innerText = "‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏á‡∏≤‡∏ô";
  document.querySelector('.form-container').scrollIntoView({ behavior: 'smooth' });
};

document.getElementById("eventForm").addEventListener("submit", async e => {
  e.preventDefault();
  const id = document.getElementById("eventId").value;
  const jobNumber = document.getElementById("jobNumber").value.trim();
  const location = document.getElementById("location").value.trim();
  const details = document.getElementById("details").value.trim();
  const orderDate = document.getElementById("orderDate").value;
  const start = document.getElementById("start").value;
  const end = document.getElementById("end").value;
  const contactPerson = document.getElementById("contactPerson").value.trim();
  const phoneNumber = document.getElementById("phoneNumber").value.trim();
  const assignerName = document.getElementById("assignedByValue").value;
  const assignerPosition = document.getElementById("positionValue").value;
  const isUrgent = document.getElementById("urgentJob").checked;

  if (!assignerName) {
    alert("‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏ô‡∏™‡∏±‡πà‡∏á‡∏á‡∏≤‡∏ô ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö URL");
    return;
  }

  if (!assignerPosition) {
    alert("‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏Ñ‡∏ô‡∏™‡∏±‡πà‡∏á‡∏á‡∏≤‡∏ô ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö URL");
    return;
  }

  let jobTypes = Array.from(document.querySelectorAll("#jobTypeGroup input[type=checkbox]:checked")).map(cb => cb.value);
  if (document.getElementById("otherJobTypeCheck").checked) {
    const otherText = document.getElementById("otherJobTypeText").value.trim();
    if (otherText) jobTypes = jobTypes.filter(t => "‡∏≠‡∏∑‡πà‡∏ô‡πÜ" !== t).concat(otherText);
  }

  if (jobTypes.length === 0) {
    alert("‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏•‡∏±‡∏Å‡∏©‡∏ì‡∏∞‡∏á‡∏≤‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£");
    return;
  }

  try {
    if (jobNumber) {
      const eventsRef = ref(db, "events");
      const snapshot = await get(eventsRef);
      
      if (snapshot.exists()) {
        const events = snapshot.val();
        const duplicate = Object.keys(events).find(key => {
          return events[key].jobNumber === jobNumber && key !== id;
        });
        
        if (duplicate) {
          alert(`‚ö†Ô∏è ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏á‡∏≤‡∏ô "${jobNumber}" ‡∏ã‡πâ‡∏≥‡∏Å‡∏±‡∏ö‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß!\n‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà`);
          return;
        }
      }
    }

    const eventData = {
      jobNumber, 
      location, 
      details, 
      orderDate, 
      start, 
      end, 
      assigners: [assignerName],
      assignerPositions: [assignerPosition],
      jobTypes, 
      contactPerson: encodeData(contactPerson),
      phoneNumber: encodeData(phoneNumber),
      isUrgent: isUrgent,
    };

    if (id) {
      await update(ref(db, `events/${id}`), {
        ...eventData,
        status: eventData.isUrgent ? "‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏î‡πà‡∏ß‡∏ô" : "‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥"
      });
      alert("‚úÖ ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏á‡∏≤‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß");
    } else {
      const newEventRef = push(ref(db, "events"));
      await set(newEventRef, {
        ...eventData,
        status: eventData.isUrgent ? "‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏î‡πà‡∏ß‡∏ô" : "‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥"
      });
      alert("‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏á‡∏≤‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß");
    }

    await clearFormAfterSave();
    loadEvents();
  } catch (err) {
    console.error(err);
    alert("‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á");
  }
});

loadEvents();
getDataFromURL();

const userId = sessionStorage.getItem("userId");
const userName = sessionStorage.getItem("userName");

if (!userId || !userName) {
  const overlay = document.createElement('div');
  overlay.className = 'custom-alert-overlay';
  
  overlay.innerHTML = `
    <div class="custom-alert-box">
      <div class="custom-alert-icon">‚ö†Ô∏è</div>
      <h2 class="custom-alert-title">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</h2>
      <p class="custom-alert-message">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</p>
      <p class="custom-alert-redirect">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ô‡∏≥‡∏Ñ‡∏∏‡∏ì‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å...</p>
      <div class="custom-alert-progress">
        <div class="custom-alert-progress-bar"></div>
      </div>
    </div>
  `;
  
  document.body.appendChild(overlay);
  
  setTimeout(() => {
    window.location.href = 'index.html';
  }, 3000);
}

document.querySelectorAll('#jobTypeGroup input[type="checkbox"]').forEach(cb => {
  cb.addEventListener('change', () => {
    const selected = Array.from(document.querySelectorAll('#jobTypeGroup input[type="checkbox"]:checked'))
      .map(cb => cb.value);

    const otherText = document.getElementById("otherJobTypeText").value.trim();
    if (document.getElementById("otherJobTypeCheck").checked && otherText) {
      selected.push(otherText);
    }

    localStorage.setItem('savedJobTypes', JSON.stringify(selected));
  });
});

document.getElementById("otherJobTypeText").addEventListener("input", () => {
  const otherCheck = document.getElementById("otherJobTypeCheck");
  if (otherCheck.checked) {
    const selected = Array.from(document.querySelectorAll('#jobTypeGroup input[type="checkbox"]:checked'))
      .map(cb => cb.value);

    const otherText = document.getElementById("otherJobTypeText").value.trim();
    if (otherText) selected.push(otherText);

    localStorage.setItem('savedJobTypes', JSON.stringify(selected));
  }
});

window.addEventListener('DOMContentLoaded', () => {
  const saved = JSON.parse(localStorage.getItem('savedJobTypes') || '[]');
  if (saved.length > 0) {
    document.querySelectorAll('#jobTypeGroup input[type="checkbox"]').forEach(cb => {
      if (saved.includes(cb.value)) cb.checked = true;
    });
    const knownTypes = ["‡∏™‡πà‡∏á‡∏°‡∏≠‡∏ö", "‡∏ù‡∏∂‡∏Å‡∏≠‡∏ö‡∏£‡∏°", "‡∏≠‡∏≠‡∏Å‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤", "‡∏ï‡∏£‡∏ß‡∏à‡πÄ‡∏ä‡πá‡∏Ñ/‡∏ã‡πà‡∏≠‡∏°", "Visit", "‡∏≠‡∏∑‡πà‡∏ô‡πÜ"];
    const other = saved.find(v => !knownTypes.includes(v));
    if (other) {
      document.getElementById("otherJobTypeCheck").checked = true;
      document.getElementById("otherJobTypeText").value = other;
    }
  }
});

function saveFormToLocalStorage() {
  const formData = {
    jobNumber: document.getElementById("jobNumber").value.trim(),
    location: document.getElementById("location").value.trim(),
    details: document.getElementById("details").value.trim(),
    orderDate: document.getElementById("orderDate").value,
    start: document.getElementById("start").value,
    end: document.getElementById("end").value,
    contactPerson: document.getElementById("contactPerson").value.trim(),
    phoneNumber: document.getElementById("phoneNumber").value.trim(),
    assignedBy: document.getElementById("assignedByValue").value,
    position: document.getElementById("positionValue").value,
    jobTypes: Array.from(document.querySelectorAll('#jobTypeGroup input[type="checkbox"]:checked')).map(cb => cb.value),
    otherJobTypeText: document.getElementById("otherJobTypeText").value.trim(),
    isUrgent: document.getElementById("urgentJob").checked
  };
  localStorage.setItem("eventFormData", JSON.stringify(formData));
}

function loadFormFromLocalStorage() {
  const saved = JSON.parse(localStorage.getItem("eventFormData") || "{}");
  if (!saved || Object.keys(saved).length === 0) return;

  document.getElementById("jobNumber").value = saved.jobNumber || "";
  document.getElementById("location").value = saved.location || "";
  document.getElementById("details").value = saved.details || "";
  document.getElementById("orderDate").value = saved.orderDate || "";
  document.getElementById("start").value = saved.start || "";
  document.getElementById("end").value = saved.end || "";
  document.getElementById("contactPerson").value = saved.contactPerson || "";
  document.getElementById("phoneNumber").value = saved.phoneNumber || "";
  document.getElementById("urgentJob").checked = saved.isUrgent || false;

  document.querySelectorAll('#jobTypeGroup input[type="checkbox"]').forEach(cb => {
    cb.checked = saved.jobTypes?.includes(cb.value) || false;
  });
  if (saved.otherJobTypeText) {
    document.getElementById("otherJobTypeCheck").checked = true;
    document.getElementById("otherJobTypeText").value = saved.otherJobTypeText;
  }
}

document.querySelectorAll('#eventForm input, #eventForm textarea').forEach(el => {
  el.addEventListener('input', saveFormToLocalStorage);
});
document.querySelectorAll('#eventForm input[type="checkbox"]').forEach(cb => {
  cb.addEventListener('change', saveFormToLocalStorage);
});

window.addEventListener('DOMContentLoaded', loadFormFromLocalStorage);

async function clearFormAfterSave() {
  localStorage.removeItem("eventFormData");
  localStorage.removeItem("savedJobTypes");

  const form = document.getElementById("eventForm");
  form.reset();

  document.getElementById("eventId").value = "";
  document.getElementById("otherJobTypeText").value = "";

  document.querySelectorAll("#jobTypeGroup input[type=checkbox]").forEach(cb => cb.checked = false);

  document.getElementById("formTitle").innerText = "‚ú® ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà";
  
  const today = new Date().toISOString().split("T")[0];
  document.getElementById("orderDate").value = today;
  
  getDataFromURL();
}

function goToReportPage(page) {
  const jobNumber = document.getElementById("jobNumber").value.trim() || "‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏";
  const start = document.getElementById("start").value;
  const end = document.getElementById("end").value;

  if (!start || !end) {
    alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÅ‡∏•‡∏∞‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡∏Å‡πà‡∏≠‡∏ô");
    return;
  }

  const url = `${page}?job=${encodeURIComponent(jobNumber)}&start=${encodeURIComponent(start)}&end=${encodeURIComponent(end)}`;
  window.location.href = url;
}

document.querySelector('input[value="‡∏™‡πà‡∏á‡∏°‡∏≠‡∏ö"]')?.addEventListener('change', (e) => {
  if (e.target.checked) goToReportPage("report_send.html");
});
document.querySelector('input[value="‡∏ù‡∏∂‡∏Å‡∏≠‡∏ö‡∏£‡∏°"]')?.addEventListener('change', (e) => {
  if (e.target.checked) goToReportPage("seereport4.html");
});
document.querySelector('input[value="‡∏≠‡∏≠‡∏Å‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤"]')?.addEventListener('change', (e) => {
  if (e.target.checked) goToReportPage("seereport2.html");
});
document.querySelector('input[value="‡∏ï‡∏£‡∏ß‡∏à‡πÄ‡∏ä‡πá‡∏Ñ/‡∏ã‡πà‡∏≠‡∏°"]')?.addEventListener('change', (e) => {
  if (e.target.checked) goToReportPage("seereport3.html");
});

// ‚úÖ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏û‡∏¥‡∏°‡∏û‡πå‡∏á‡∏≤‡∏ô - ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÉ‡∏´‡πâ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ö‡∏ô iOS
window.printEvent = async (id) => {
  // ‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡∏Å‡πà‡∏≠‡∏ô‡∏ó‡∏≥ async operation (‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö iOS)
  const newWindow = window.open('', '_blank');
  
  try {
    const eventRef = ref(db, `events/${id}`);
    const snapshot = await get(eventRef);

    if (!snapshot.exists()) {
      newWindow.close();
      alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏á‡∏≤‡∏ô");
      return;
    }

    const data = snapshot.val();
    const jobNumber = data.jobNumber || "‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏";
    
    let position = "";
    
    if (data.assignerPositions && data.assignerPositions.length > 0) {
      position = data.assignerPositions[0];
    } else if (data.position) {
      position = data.position;
    } else {
      position = sessionStorage.getItem("assignedByPosition") || "";
    }

    console.log("üîç Debug printEvent:", {
      jobNumber,
      position,
      assignerPositions: data.assignerPositions,
      allData: data
    });

    const url = new URL("reportS.html", window.location.href);
    url.searchParams.set("job", jobNumber);
    
    // ‚úÖ ‡∏™‡πà‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÑ‡∏õ‡∏î‡πâ‡∏ß‡∏¢‡πÄ‡∏™‡∏°‡∏≠
    if (position) {
      url.searchParams.set("position", position);
    } else {
      console.warn("‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• position ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô:", jobNumber);
    }

    console.log("üñ® ‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏û‡∏¥‡∏°‡∏û‡πå:", url.toString());
    
    // ‡∏ô‡∏≥‡∏ó‡∏≤‡∏á‡πÑ‡∏õ‡∏¢‡∏±‡∏á URL ‡∏ó‡∏µ‡πà‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ß‡πâ
    newWindow.location = url.toString();
  } catch (error) {
    console.error("Error opening print page:", error);
    if (newWindow) newWindow.close();
    alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏û‡∏¥‡∏°‡∏û‡πå");
  }
};

</script>
</body>
</html>