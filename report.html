<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<title>‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏á‡∏≤‡∏ô / ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô</title>

<!-- PDF Export -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<!-- Firebase -->
<script type="module" src="https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js"></script>
<script type="module" src="https://www.gstatic.com/firebasejs/12.3.0/firebase-database.js"></script>

<style>
* { box-sizing: border-box; }

body { 
  font-family: "TH Sarabun New", sans-serif; 
  background: #f8fafc; 
  margin: 0; 
  padding: 0;
  font-size: 16px;
}

/* Header Bar - Mobile First */
.header-bar { 
  display: flex; 
  flex-direction: column;
  gap: 12px;
  align-items: stretch;
  background: linear-gradient(135deg, #c82a11, #ff0101); 
  color: #fff; 
  padding: 16px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.15);
  position: sticky;
  top: 0;
  z-index: 100;
}

.header-bar h1 { 
  margin: 0; 
  font-size: 18px; 
  font-weight: 600;
  text-align: center;
}

.header-bar button { 
  background: rgba(255,255,255,0.2); 
  color: #fff; 
  border: 1px solid rgba(255,255,255,0.4); 
  border-radius: 12px; 
  padding: 12px 20px; 
  cursor: pointer;
  font-size: 15px;
  font-weight: 500;
  transition: all 0.3s;
  width: 100%;
}

.header-bar button:hover { 
  background: rgba(255,255,255,0.3); 
  transform: translateY(-1px);
}

/* Button Group - Mobile First */
.btn-group { 
  display: flex; 
  flex-direction: column;
  gap: 12px;
  padding: 16px;
  background: #fff;
  margin: 0;
  box-shadow: 0 2px 4px rgba(0,0,0,0.05);
}

.search-box { 
  display: flex; 
  flex-direction: column;
  gap: 8px;
  width: 100%;
}

.search-box label {
  font-weight: 600;
  color: #334155;
  font-size: 15px;
}

.btn { 
  background: #ff0101; 
  color: #fff; 
  border: none; 
  padding: 14px 20px; 
  border-radius: 12px; 
  cursor: pointer; 
  font-size: 16px; 
  font-weight: 600; 
  transition: all 0.3s;
  width: 100%;
  box-shadow: 0 4px 6px rgba(255, 1, 1, 0.2);
}

.btn:hover { 
  background: #c82a11; 
  transform: translateY(-2px);
  box-shadow: 0 6px 12px rgba(255, 1, 1, 0.3);
}

.btn:active {
  transform: translateY(0);
}

.btn:disabled { 
  background: #94a3b8; 
  cursor: not-allowed;
  transform: none;
  box-shadow: none;
}

.btn.secondary { 
  background: #64748b;
  box-shadow: 0 4px 6px rgba(100, 116, 139, 0.2);
}

.btn.secondary:hover { 
  background: #475569; 
}

/* Container - Mobile First */
.container { 
  width: 100%;
  background: #fff; 
  margin: 0;
  padding: 20px 16px;
  box-shadow: none;
  min-height: calc(100vh - 200px);
  font-size: 14px;
}

/* Header Title */
.header-title { 
  text-align: center; 
  margin-bottom: 4mm;
}

.header-title h2 { 
  margin: 0 0 2mm 0; 
  text-decoration: underline;
  font-weight: 700; 
  font-size: 18px;
}

.header-title .jobno { 
  text-align: right; 
  font-size: 14px; 
  margin-top: 0;
}

/* Form Lines */
.line { 
  border-bottom: 1px dotted #000; 
  display: inline-block; 
  min-width: 35mm;
  padding: 2px 0; 
  text-align: center;
  line-height: 1.8;
}

.lines { 
  border-bottom: 1px dotted #000; 
  display: inline-block; 
  min-width: 35mm;
  padding: 2px 0; 
  text-align: center;
  line-height: 1.8;
}

.line1 { 
  border-bottom: 1px dotted #000; 
  display: inline-block; 
  min-width: 36.7mm;
  padding: 2px 0; 
  text-align: center;
  line-height: 1.8;
}

.line2 { 
  border-bottom: 1px dotted #000; 
  display: inline-block; 
  min-width: 58.4mm;
  padding: 2px 0; 
  text-align: center;
  line-height: 1.8;
}

.line3 { 
  border-bottom: 1px dotted #000; 
  display: inline-block; 
  min-width: 145mm;
  padding: 2px 0; 
  text-align: center;
  line-height: 1.8;
}

.line4 { 
  border-bottom: 1px dotted #000; 
  display: inline-block; 
  min-width: 60mm;
  padding: 2px 0; 
  text-align: center;
  line-height: 1.8;
}

.line5 { 
  border-bottom: 1px dotted #000; 
  display: inline-block; 
  min-width: 127.5mm;
  padding: 2px 0; 
  text-align: center;
  line-height: 1.8;
}

.line6 { 
  border-bottom: 1px dotted #000; 
  display: inline-block; 
  min-width: 180mm;
  padding: 2px 0; 
  text-align: center;
  min-height: 10mm;
  vertical-align: top;
  line-height: 1.8;
}

.line7 { 
  border-bottom: 1px dotted #000; 
  display: inline-block; 
  min-width: 154mm;
  padding: 2px 0; 
  text-align: center;
  line-height: 1.8;
}

.line8 { 
  border-bottom: 1px dotted #000; 
  display: inline-block; 
  min-width: 75.5mm;
  padding: 2px 0; 
  text-align: center;
  line-height: 1.8;
}

.line9 { 
  border-bottom: 1px dotted #000; 
  display: inline-block; 
  min-width: 156.5mm;
  padding: 2px 0; 
  text-align: center;
  line-height: 1.8;
}

/* Section */
.section { 
  margin-top: 4mm;
  line-height: 1.5;
}

/* Details Box */
.details-box {
  border-bottom: 1px dotted #000;
  min-height: 8mm;
  padding: 2px 0;
  line-height: 1.8;
}

/* Input Styling - Mobile First */
input[type="text"] { 
  padding: 12px 16px; 
  font-size: 16px; 
  border: 2px solid #e2e8f0; 
  border-radius: 12px; 
  width: 100%;
  transition: all 0.3s;
  background: #f8fafc;
}

input[type="text"]:focus {
  outline: none;
  border-color: #ff0101;
  background: #fff;
  box-shadow: 0 0 0 3px rgba(255, 1, 1, 0.1);
}

input[type="checkbox"] { 
  transform: scale(1.3); 
  margin-right: 6px;
  cursor: pointer;
}

.section label {
  cursor: pointer;
}

textarea { 
  width: 100%; 
  border: none; 
  border-bottom: 1px dotted #000; 
  resize: none; 
  font-size: 14px; 
  background: transparent; 
  padding: 3px 0;
}

/* Signature Section */
.signature { 
  margin-top: 18mm;
  display: flex; 
  justify-content: space-between;
  align-items: flex-start;
}

.signature div { 
  text-align: center; 
  width: 45%;
  font-size: 14px;
  line-height: 1.5;
}

.signature img { 
  max-height: 40px;
}

/* Tablet Styles */
@media (min-width: 640px) {
  .header-bar {
    flex-direction: row;
    justify-content: space-between;
    align-items: center;
    padding: 12px 24px;
  }
  
  .header-bar h1 {
    font-size: 16px;
    text-align: left;
  }
  
  .header-bar button {
    width: auto;
    padding: 6px 24px;
  }
  
  .btn-group {
    flex-direction: row;
    justify-content: center;
    align-items: center;
    padding: 10px 24px;
  }
  
  .search-box {
    flex-direction: row;
    align-items: center;
    width: auto;
  }
  
  .search-box label {
    margin: 0;
  }
  
  .search-box input {
    width: 200px;
  }
  
  .btn {
    width: auto;
    min-width: 140px;
    padding: 8px 14px;
    font-size: 14px;
  }
  
  input[type="checkbox"] {
    transform: scale(1.1);
    margin-right: 3px;
  }
}

/* Desktop Styles */
@media (min-width: 1024px) {
  body {
    background: #f8fafc;
  }
  
  .container {
    width: 210mm;
    margin: 10px auto;
    padding: 18mm;
    box-shadow: 0 6px 20px rgba(0,0,0,0.08);
    border-radius: 12px;
    transition: opacity 0.3s;
  }
  
  .header-bar {
    position: static;
  }
}

/* Print Styles - A4 Paper */
@media print {
  @page {
    size: A4 portrait;
    margin: 0;
  }
  
  body {
    margin: 0;
    padding: 0;
  }
  
  .container {
    width: 210mm !important;
    padding: 18mm !important;
    margin: 0 !important;
    box-shadow: none !important;
    border-radius: 0 !important;
  }
  
  .line, .lines, .line1, .line2, .line3, .line4, .line5, .line6, .line7, .line8, .line9 {
    border-bottom: 1px dotted #000 !important;
    padding: 2px 0 !important;
    line-height: 1.8 !important;
    display: inline-block !important;
    box-sizing: border-box !important;
  }
  
  .line { min-width: 35mm !important; width: 35mm !important; }
  .lines { min-width: 35mm !important; width: 35mm !important; }
  .line1 { min-width: 36.7mm !important; width: 36.7mm !important; }
  .line2 { min-width: 58.4mm !important; width: 58.4mm !important; }
  .line3 { min-width: 145mm !important; width: 145mm !important; }
  .line4 { min-width: 60mm !important; width: 60mm !important; }
  .line5 { min-width: 127.5mm !important; width: 127.5mm !important; }
  .line6 { min-width: 180mm !important; width: 180mm !important; min-height: 10mm !important; }
  .line7 { min-width: 154mm !important; width: 154mm !important; }
  .line8 { min-width: 75.5mm !important; width: 75.5mm !important; }
  .line9 { min-width: 156.5mm !important; width: 156.5mm !important; }
  
  .section {
    margin-top: 4mm !important;
  }
  
  .signature {
    margin-top: 18mm !important;
  }
  
  .details-box {
    min-height: 8mm !important;
  }
  
  .header-bar, .btn-group {
    display: none !important;
  }
}
</style>
</head>

<body>

<div class="header-bar">
  <h1>üìÑ ‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏á‡∏≤‡∏ô / ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô</h1>
  <button onclick="window.location.href='notchoose.html'">‚¨Ö ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å</button>
</div>

<div class="btn-group">
  <div class="search-box">
    <label>Job Number:</label>
    <input type="text" id="jobNumberInput" placeholder="‡∏Å‡∏£‡∏≠‡∏Å Job Number...">
    <button class="btn secondary" id="searchBtn">üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</button>
  </div>
  <button class="btn" id="printBtn">üñ®Ô∏è ‡∏õ‡∏£‡∏¥‡πâ‡∏ô PDF</button>
</div>

<div id="report" class="container">

  <!-- üîπ ‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠ + ‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏™‡∏±‡πà‡∏á‡∏á‡∏≤‡∏ô -->
  <div class="header-title">
    <h2>‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏á‡∏≤‡∏ô / ‡πÉ‡∏ö‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô</h2>
    <div class="jobno">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà: <span id="jobNo" class="line"></span></div>
  </div>

  <div class="section" style="margin-top:3mm;">
    ‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏™‡∏±‡πà‡∏á‡∏á‡∏≤‡∏ô: <span id="assignedBy" class="line"></span>
    ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏±‡πà‡∏á‡∏á‡∏≤‡∏ô: <span id="orderDate" class="line"></span>
    ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à‡∏á‡∏≤‡∏ô: <span id="deadlines" class="line1"></span><br>
  </div>

  <div class="section" style="margin-top:3mm;">
    ‡∏•‡∏±‡∏Å‡∏©‡∏ì‡∏∞‡∏á‡∏≤‡∏ô:
    <div style="text-align: right;">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà JOB: <span id="docNo" class="line"></span></div>
    <label><input type="checkbox" id="type1"> ‡∏™‡πà‡∏á‡∏°‡∏≠‡∏ö</label>
    <label><input type="checkbox" id="type2"> ‡∏ù‡∏∂‡∏Å‡∏≠‡∏ö‡∏£‡∏°</label>
    <label><input type="checkbox" id="type3"> ‡∏ï‡∏£‡∏ß‡∏à‡πÄ‡∏ä‡πá‡∏Å/‡∏ã‡πà‡∏≠‡∏°</label>
    <label><input type="checkbox" id="type4"> Visit</label>
    <label><input type="checkbox" id="type5"> ‡∏≠‡∏∑‡πà‡∏ô ‡πÜ</label>
  </div>

  <div class="section" style="margin-top:3mm;">
    ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏á‡∏≤‡∏ô:<br>
    <div class="details-box">
      <span id="details"></span>
    </div>
    <div class="details-box">
      <span id="details2"></span>
    </div>
  </div>

  <div class="section" style="margin-top:4mm;">
    ‡∏≠‡∏≠‡∏Å‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: <span id="date" class="line2"></span>
    ‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á‡∏Å‡∏•‡∏±‡∏ö‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: <span id="deadline" class="line2"></span>
  </div>

  <div class="section">
    ‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô: <span id="location" class="line3"></span>
  </div>

  <div class="section">
    ‡∏ú‡∏π‡πâ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠: <span id="contactName" class="line4"></span>
    ‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå: <span id="contactPhone" class="line8"></span>
  </div>

  <div class="section">
    ‡∏ú‡∏π‡πâ‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô: <span id="title" class="line7"></span>
  </div>

  <div>
    <br><br>---------------------------------------------------------------------------------------------------------------------------------
  </div>

  <div class="section">
    ‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô:<br><br>
    <label><input type="checkbox" id="success"> ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢</label>
    <label><input type="checkbox" id="fail"> ‡πÑ‡∏°‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢</label>
    <span id="incompleteReason" class="line5"></span><br><br>
    ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: <span id="note" class="line9"></span>
  </div>

  <div class="signature">
    <div>
      <br><br><br>(..........................................)<br><br><br>
      ‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö‡∏á‡∏≤‡∏ô
    </div>
    <div style="position:relative;">
      <img id="signatureImg" 
           src="https://i.postimg.cc/Ny0GLn2m/signature.png" 
           style="display:none; max-height:60px; position:absolute; bottom: 70px; left:52%; transform:translateX(-50%);"
           crossorigin="anonymous">
      <br><br><br>(..........................................)<br><br><br>
      ‡∏ú‡∏π‡πâ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ / ‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£
    </div>
  </div>
  
  <div class="signature" style="margin-top:8mm; font-size:12px;">
    <div style="text-align:left;">
      <u>‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç!</u> ‡∏Å‡∏≤‡∏£‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£<br>
      1. ‡∏™‡πà‡∏á‡∏°‡∏≠‡∏ö‡∏á‡∏≤‡∏ô ‡πÅ‡∏•‡∏∞‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 7 ‡∏ß‡∏±‡∏ô‡∏ó‡∏≥‡∏Å‡∏≤‡∏£<br>
      2. ‡∏ù‡∏∂‡∏Å‡∏≠‡∏ö‡∏£‡∏° ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 5 ‡∏ß‡∏±‡∏ô‡∏ó‡∏≥‡∏Å‡∏≤‡∏£<br>
      3. ‡∏≠‡∏≠‡∏Å‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 10 ‡∏ß‡∏±‡∏ô‡∏ó‡∏≥‡∏Å‡∏≤‡∏£<br>
      4. ‡∏ï‡∏£‡∏ß‡∏à‡πÄ‡∏ä‡πá‡∏Ñ/‡∏ã‡πà‡∏≠‡∏° ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 3 ‡∏ß‡∏±‡∏ô‡∏ó‡∏≥‡∏Å‡∏≤‡∏£<br>
      5. Visit ‡∏á‡∏≤‡∏ô ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 5 ‡∏ß‡∏±‡∏ô‡∏ó‡∏≥‡∏Å‡∏≤‡∏£
    </div>
    <div>
      ‡∏Å‡∏£‡∏ì‡∏µ‡∏î‡πà‡∏ß‡∏ô!<br><br><br>
      (..........................................)<br>
      ‡∏ú‡∏π‡πâ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥/‡∏Ñ‡∏∏‡∏ì‡∏â‡∏±‡∏ï‡∏£‡∏ä‡∏±‡∏¢
    </div>
  </div>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
import { getDatabase, ref, query, orderByChild, equalTo, get } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyABY8jkjB2RD3RPK-qQ6kJThm32Pc9OpKE",
  authDomain: "events-93cb9.firebaseapp.com",
  databaseURL: "https://events-93cb9-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "events-93cb9",
  storageBucket: "events-93cb9.firebasestorage.app",
  messagingSenderId: "234410411694",
  appId: "1:234410411694:web:b544058bce0dfe78a88f3f",
  measurementId: "G-4D3X216R1K"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

function decodeData(encodedText) {
  if (!encodedText) return "";
  
  try {
    let decoded = decodeURIComponent(escape(atob(encodedText)));
    console.log("üîç Decode ‡∏£‡∏≠‡∏ö 1 (Base64):", decoded);
    
    if (decoded.includes('%')) {
      console.log("üîç ‡∏ï‡∏£‡∏ß‡∏à‡∏û‡∏ö double encoding - decode ‡∏≠‡∏µ‡∏Å‡∏£‡∏≠‡∏ö");
      decoded = decodeURIComponent(decoded);
      console.log("‚úÖ Decode ‡∏£‡∏≠‡∏ö 2 (URL):", decoded);
    }
    
    return decoded;
  } catch (error) {
    try {
      if (encodedText.includes('%')) {
        console.log("üîç ‡∏ï‡∏£‡∏ß‡∏à‡∏û‡∏ö URL encoding ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á");
        return decodeURIComponent(encodedText);
      }
    } catch (e) {
      console.error("‚ö†Ô∏è Error decoding:", e);
    }
    
    console.warn("‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ decode - ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡πâ‡∏ô‡∏â‡∏ö‡∏±‡∏ö");
    return encodedText;
  }
}

const jobNumberInput = document.getElementById("jobNumberInput");
const searchBtn = document.getElementById("searchBtn");
const signatureImg = document.getElementById("signatureImg");

let isDataLoaded = false;

function getParamsFromURL() {
  const urlParams = new URLSearchParams(window.location.search);
  return {
    jobNumber: urlParams.get('job'),
    start: urlParams.get('start'),
    end: urlParams.get('end')
  };
}

async function searchAndDisplay(jobNum = null) {
  const jobNumber = jobNum || jobNumberInput.value.trim();
  
  if (!jobNumber) {
    alert("‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å Job Number");
    return;
  }

  document.getElementById("report").style.opacity = "0.5";
  isDataLoaded = false;

  try {
    const eventsRef = ref(db, 'events');
    const q = query(eventsRef, orderByChild('jobNumber'), equalTo(jobNumber));
    const snapshot = await get(q);

    if (!snapshot.exists()) {
      alert("‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Job Number: " + jobNumber);
      document.getElementById("report").style.opacity = "1";
      return;
    }

    let data = null;
    snapshot.forEach((childSnapshot) => {
      if (!data) {
        data = childSnapshot.val();
      }
    });

    if (!data) {
      alert("‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Job Number: " + jobNumber);
      document.getElementById("report").style.opacity = "1";
      return;
    }
    
    if (data.signType === "‡πÄ‡∏ã‡πá‡∏ô‡πÄ‡∏≠‡∏á") {
      const currentParams = new URLSearchParams(window.location.search);
      window.location.href = `reportAp.html?${currentParams.toString()}`;
      return;
    }

    signatureImg.style.display = (data.status === "‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥" || data.status === "‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢" || data.status === "‡πÑ‡∏°‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢") ? "block" : "none";
    
    function formatDateThai(dateStr) {
      if (!dateStr) return "";
      const date = new Date(dateStr);
      const day = date.getDate();
      const month = date.getMonth() + 1;
      const year = date.getFullYear() + 543;
      return `${day}/${month}/${year}`;
    }

    const formattedStart = formatDateThai(data.start);
    const formattedOrderDate = formatDateThai(data.orderDate);
    const formattedEnd = formatDateThai(data.end);

    document.getElementById("docNo").textContent = data.jobNumber || "";
    document.getElementById("jobNo").textContent = data.job || "";
    document.getElementById("assignedBy").textContent = (data.assigners || []).join(", ");
    document.getElementById("date").textContent = formattedStart;
    document.getElementById("orderDate").textContent = formattedOrderDate;
    document.getElementById("deadline").textContent = formattedEnd;
    document.getElementById("deadlines").textContent = formattedEnd;

    const detailsText = data.details || "";
    const maxLength = 100;
    if (detailsText.length > maxLength) {
      document.getElementById("details").textContent = detailsText.substring(0, maxLength);
      document.getElementById("details2").textContent = detailsText.substring(maxLength);
    } else {
      document.getElementById("details").textContent = detailsText;
      document.getElementById("details2").textContent = "";
    }
    
    document.getElementById("location").textContent = data.location || "";
    document.getElementById("title").textContent = (data.workers || []).join(", ");
    
    document.getElementById("contactName").textContent = decodeData(data.contactPerson) || "-";
    document.getElementById("contactPhone").textContent = decodeData(data.phoneNumber) || "-";

    ["type1","type2","type3","type4","type5"].forEach(id => document.getElementById(id).checked=false);

    if (data.jobTypes) {
      if (data.jobTypes.includes("‡∏™‡πà‡∏á‡∏°‡∏≠‡∏ö")) document.getElementById("type1").checked = true;
      if (data.jobTypes.includes("‡∏ù‡∏∂‡∏Å‡∏≠‡∏ö‡∏£‡∏°")) document.getElementById("type2").checked = true;
      if (data.jobTypes.includes("‡∏ï‡∏£‡∏ß‡∏à‡πÄ‡∏ä‡πá‡∏Ñ/‡∏ã‡πà‡∏≠‡∏°")) document.getElementById("type3").checked = true;
      if (data.jobTypes.includes("Visit")) document.getElementById("type4").checked = true;

      const other = data.jobTypes.find(t =>
        !["‡∏™‡πà‡∏á‡∏°‡∏≠‡∏ö","‡∏ù‡∏∂‡∏Å‡∏≠‡∏ö‡∏£‡∏°","‡∏ï‡∏£‡∏ß‡∏à‡πÄ‡∏ä‡πá‡∏Ñ/‡∏ã‡πà‡∏≠‡∏°","Visit"].includes(t)
      );
      if (other) document.getElementById("type5").checked = true;
    }

    document.getElementById("success").checked = data.status === "‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢";
    document.getElementById("fail").checked = data.status === "‡πÑ‡∏°‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢";
    document.getElementById("note").textContent = data.remark || "";
    document.getElementById("incompleteReason").textContent = data.incompleteReason || "";

    isDataLoaded = true;
    document.getElementById("report").style.opacity = "1";
    alert("‚úÖ ‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Job Number: " + jobNumber);

  } catch (error) {
    console.error("Error:", error);
    alert("‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + error.message);
    document.getElementById("report").style.opacity = "1";
    isDataLoaded = false;
  }
}

searchBtn.addEventListener("click", () => searchAndDisplay());
jobNumberInput.addEventListener("keypress", (e) => {
  if (e.key === "Enter") searchAndDisplay();
});

window.addEventListener('DOMContentLoaded', async () => {
  console.log("üåê ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö...");
  await new Promise(resolve => setTimeout(resolve, 1500));
  console.log("‚úÖ Firebase ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô");
  
  const params = getParamsFromURL();
  
  if (params.jobNumber) {
    jobNumberInput.value = params.jobNumber;
    if (params.start) console.log("‡∏ß‡∏±‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°:", params.start);
    if (params.end) console.log("‡∏ß‡∏±‡∏ô‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î:", params.end);
    searchAndDisplay(params.jobNumber);
  }
});

document.getElementById("printBtn").addEventListener("click", async () => {
  console.log("üîç ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡πà‡∏≠‡∏ô‡∏õ‡∏£‡∏¥‡πâ‡∏ô...");
  
  if (!isDataLoaded) {
    alert("‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡πà‡∏≠‡∏ô‡∏õ‡∏£‡∏¥‡πâ‡∏ô!");
    return;
  }

  const jobNumber = document.getElementById("docNo").textContent.trim();
  if (!jobNumber) {
    alert("‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ü‡∏≠‡∏£‡πå‡∏° ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÉ‡∏´‡∏°‡πà!");
    isDataLoaded = false;
    return;
  }

  const printBtn = document.getElementById("printBtn");
  const originalText = printBtn.textContent;
  printBtn.textContent = "‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á PDF...";
  printBtn.disabled = true;

  try {
    console.log("üìÑ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡∏£‡πâ‡∏≤‡∏á PDF...");
    const element = document.getElementById("report");
    const filename = `${jobNumber}.pdf`;

    const signatureImg = document.getElementById("signatureImg");
    if (signatureImg && signatureImg.style.display !== "none") {
      console.log("‚è≥ ‡∏£‡∏≠‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô...");
      
      const preloadImg = new Image();
      preloadImg.crossOrigin = "anonymous";
      preloadImg.src = signatureImg.src;
      
      await new Promise((resolve) => {
        if (signatureImg.complete && signatureImg.naturalWidth > 0) {
          console.log("‚úÖ ‡∏£‡∏π‡∏õ‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß");
          resolve();
          return;
        }
        
        preloadImg.onload = () => {
          console.log("‚úÖ Preload ‡∏£‡∏π‡∏õ‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
          signatureImg.src = preloadImg.src;
          setTimeout(resolve, 500);
        };
        
        preloadImg.onerror = () => {
          console.log("‚ö†Ô∏è Preload ‡∏£‡∏π‡∏õ‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß - ‡∏Ç‡πâ‡∏≤‡∏°");
          resolve();
        };
        
        setTimeout(() => {
          console.log("‚è±Ô∏è Timeout ‡∏£‡∏π‡∏õ‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô (8s)");
          resolve();
        }, 8000);
      });
    }

    console.log("‚è≥ ‡∏£‡∏≠ DOM ‡πÄ‡∏£‡∏ô‡πÄ‡∏î‡∏≠‡∏£‡πå...");
    await new Promise(resolve => setTimeout(resolve, 3000));

    console.log("üé® ‡∏Å‡∏≥‡∏•‡∏±‡∏á render HTML to Canvas...");

    await html2pdf().set({
      margin: 0,
      filename: filename,
      image: { type: "jpeg", quality: 0.98 },
      html2canvas: { 
        scale: 2.5,
        useCORS: true,
        allowTaint: true,
        logging: false,
        letterRendering: true,
        windowHeight: 297 * 3.7795275591,
        height: 297 * 3.7795275591,
        backgroundColor: '#ffffff',
        removeContainer: true,
        imageTimeout: 15000
      },
      jsPDF: { 
        unit: "mm", 
        format: "a4", 
        orientation: "portrait",
        compress: true
      },
      pagebreak: { mode: 'avoid-all' }
    }).from(element).save();

    console.log("‚úÖ PDF ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!");
    alert("‚úÖ ‡∏™‡∏£‡πâ‡∏≤‡∏á PDF ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + filename);

  } catch (error) {
    console.error("‚ùå PDF Error:", error);
    alert("‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + error.message);
  } finally {
    printBtn.textContent = originalText;
    printBtn.disabled = false;
  }
});
</script>
</body>
</html>