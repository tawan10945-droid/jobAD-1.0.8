<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏á‡∏≤‡∏ô / ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô</title>

<!-- PDF Export -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<!-- Firebase -->
<script type="module" src="https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js"></script>
<script type="module" src="https://www.gstatic.com/firebasejs/12.3.0/firebase-database.js"></script>

<style>
body { font-family: "TH Sarabun New", sans-serif; background: #f8fafc; margin:0; font-size:14px; }
.header-bar { display:flex; justify-content:space-between; align-items:center; background:linear-gradient(90deg,#c82a11,#ff0101); color:#fff; padding:12px 10px; }
.header-bar h1 { margin:0; font-size:16px; font-weight:600; }
.header-bar button { background:rgba(255,255,255,0.15); color:#fff; border:1px solid rgba(255,255,255,0.3); border-radius:8px; padding:6px 12px; cursor:pointer; }
.header-bar button:hover { background:rgba(255,255,255,0.25); }

.btn-group { display:flex; justify-content:center; gap:10px; margin:10px 0; align-items:center; }
.btn { background:#ff0101; color:#fff; border:none; padding:8px 14px; border-radius:8px; cursor:pointer; font-size:14px; font-weight:600; transition:0.2s; }
.btn:hover { background:#c82a11; }
.btn.secondary { background:#64748b; }
.btn.secondary:hover { background:#475569; }

.container { width:210mm;  background:#fff; margin:10px auto; padding:18mm; box-shadow:0 6px 20px rgba(0,0,0,0.08); border-radius:12px; box-sizing:border-box; }

.header-title { text-align:center; margin-bottom:4mm; }
.header-title h2 { margin:0 0 2mm 0; text-decoration:underline; font-weight:700; font-size:18px; }
.header-title .jobno { text-align:right; font-size:14px; margin-top:0; }

.line { border-bottom:1px dotted #000; display:inline-block; min-width:35mm; padding:2px 0; text-align:center; line-height:1.8; }
.lines { border-bottom:1px dotted #000; display:inline-block; min-width:35mm; padding:2px 0; text-align:center; line-height:1.8; }
.line1 { border-bottom:1px dotted #000; display:inline-block; min-width:36.7mm; padding:2px 0; text-align:center; line-height:1.8; }
.line2 { border-bottom:1px dotted #000; display:inline-block; min-width:58.4mm; padding:2px 0; text-align:center; line-height:1.8; }
.line3 { border-bottom:1px dotted #000; display:inline-block; min-width: 145mm; padding:2px 0; text-align:center; line-height:1.8; }
.line4 { border-bottom:1px dotted #000; display:inline-block; min-width:60mm; padding:2px 0; text-align:center; line-height:1.8; }
.line5 { border-bottom:1px dotted #000; display:inline-block; min-width:127.5mm; padding:2px 0; text-align:center; line-height:1.8; }
.line7 { border-bottom:1px dotted #000; display:inline-block; min-width:154mm; padding:2px 0; text-align:center; line-height:1.8; }
.line9 { border-bottom:1px dotted #000; display:inline-block; min-width:156.5mm; padding:2px 0; text-align:center; line-height:1.8; }
.line8 { border-bottom:1px dotted #000; display:inline-block; min-width:75.5mm; padding:2px 0; text-align:center; line-height:1.8; }
.line6 { border-bottom:1px dotted #000; display:inline-block; min-width:180mm; padding:2px 0; text-align:center; min-height:10mm; vertical-align:top; line-height:1.8; }
.section { margin-top:4mm; line-height:1.5; }
textarea { width:100%; border:none; border-bottom:1px dotted #000; resize:none; font-size:14px; background:transparent; padding:3px 0; }
input[type="checkbox"] { transform:scale(1.1); margin-right:3px; }
.signature { margin-top:18mm; display:flex; justify-content:space-between; }
.signature div { text-align:center; width:45%; font-size:14px; }
input[type="text"] { padding:8px 12px; font-size:14px; border:1px solid #ddd; border-radius:6px; width:200px; }
.search-box { display:flex; gap:10px; align-items:center; }

/* CSS ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏¥‡πâ‡∏ô - ‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏ß‡πÄ‡∏™‡πâ‡∏ô‡∏à‡∏∏‡∏î‡πÄ‡∏ó‡πà‡∏≤‡πÄ‡∏î‡∏¥‡∏° */
@media print {
  .line, .lines, .line1, .line2, .line3, .line4, .line5, .line6, .line7, .line8, .line9 {
    border-bottom: 1px dotted #000 !important;
    padding: 2px 0 !important;
    line-height: 1.8 !important;
    display: inline-block !important;
    box-sizing: border-box !important;
  }
  
  .line { min-width: 35mm !important; width: 35mm !important; }
  .lines { min-width: 35mm !important; width: 35mm !important; }
  .line1 { min-width: 36.7mm !important; width: 36.7mm !important; }
  .line2 { min-width: 58.4mm !important; width: 58.4mm !important; }
  .line3 { min-width: 145mm !important; width: 145mm !important; }
  .line4 { min-width: 60mm !important; width: 60mm !important; }
  .line5 { min-width: 127.5mm !important; width: 127.5mm !important; }
  .line6 { min-width: 180mm !important; width: 180mm !important; min-height: 10mm !important; }
  .line7 { min-width: 154mm !important; width: 154mm !important; }
  .line8 { min-width: 75.5mm !important; width: 75.5mm !important; }
  .line9 { min-width: 156.5mm !important; width: 156.5mm !important; }
  
  .container {
    width: 210mm !important;
    padding: 18mm !important;
  }
  
  .header-bar, .btn-group {
    display: none !important;
  }
}
</style>
</head>

<body>

<div class="header-bar">
  <h1>üìÑ ‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏á‡∏≤‡∏ô / ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô</h1>
  <div style="display: flex; gap: 10px;">
    <button id="backBtn" onclick="window.location.href='adminV2.html'">‚¨Ö ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å</button>
  </div>
</div>

<div class="btn-group">
  <div class="search-box">
    <label>Job Number:</label>
    <input type="text" id="jobNumberInput" placeholder="‡∏Å‡∏£‡∏≠‡∏Å Job Number...">
    <button class="btn secondary" id="searchBtn">üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</button>
  </div>
  <button class="btn" id="printBtn">üñ®Ô∏è ‡∏õ‡∏£‡∏¥‡πâ‡∏ô PDF</button>
</div>

<div id="report" class="container">

  <!-- üîπ ‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠ + ‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏™‡∏±‡πà‡∏á‡∏á‡∏≤‡∏ô (‡∏Å‡∏£‡∏∞‡∏ä‡∏±‡∏ö‡∏Ç‡∏∂‡πâ‡∏ô) -->
  <div class="header-title">
    <h2>‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏á‡∏≤‡∏ô / ‡πÉ‡∏ö‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô</h2>
    <div class="jobno">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà: <span id="jobNo" class="line"></span></div>
  </div>

  <div class="section" style="margin-top:3mm;">
    ‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏™‡∏±‡πà‡∏á‡∏á‡∏≤‡∏ô: <span id="assignedBy" class="line"></span>
    ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏±‡πà‡∏á‡∏á‡∏≤‡∏ô: <span id="orderDate" class="line"></span>
    ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à‡∏á‡∏≤‡∏ô: <span id="deadlines" class="line1"></span><br>
  </div>

  <div class="section" style="margin-top:3mm;">
    ‡∏•‡∏±‡∏Å‡∏©‡∏ì‡∏∞‡∏á‡∏≤‡∏ô:
    <div style="text-align: right;">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà JOB: <span id="docNo" class="line"></span></div>
    <label><input type="checkbox" id="type1"> ‡∏™‡πà‡∏á‡∏°‡∏≠‡∏ö</label>
    <label><input type="checkbox" id="type2"> ‡∏ù‡∏∂‡∏Å‡∏≠‡∏ö‡∏£‡∏°</label>
    <label><input type="checkbox" id="type3"> ‡∏ï‡∏£‡∏ß‡∏à‡πÄ‡∏ä‡πá‡∏Å/‡∏ã‡πà‡∏≠‡∏°</label>
    <label><input type="checkbox" id="type4"> Visit</label>
    <label><input type="checkbox" id="type5"> ‡∏≠‡∏∑‡πà‡∏ô ‡πÜ</label>
  </div>

  <div class="section" style="margin-top:3mm;">
    ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏á‡∏≤‡∏ô:<br>
    <div style="border-bottom:1px dotted #000; min-height:8mm; padding:2px 0; line-height:1.8;">
      <span id="details"></span>
    </div>
    <div style="border-bottom:1px dotted #000; min-height:8mm; padding:2px 0; line-height:1.8;">
      <span id="details2"></span>
    </div>
  </div>

  <div class="section" style="margin-top:4mm;">
    ‡∏≠‡∏≠‡∏Å‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: <span id="date" class="line2"></span>
    ‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á‡∏Å‡∏•‡∏±‡∏ö‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: <span id="deadline" class="line2"></span>
  </div>

  <div class="section">
    ‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô: <span id="location" class="line3"></span>
  </div>

  <div class="section">
    ‡∏ú‡∏π‡πâ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠: <span id="contactName" class="line4"></span>
    ‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå: <span id="contactPhone" class="line8"></span>
  </div>

  <div class="section">
    ‡∏ú‡∏π‡πâ‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô: <span id="title" class="line7"></span>
  </div>

  <div>
    <br><br>---------------------------------------------------------------------------------------------------------------------------------
  </div>

  <div class="section">
    ‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô:<br><br>
    <label><input type="checkbox" id="success"> ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢</label>
    <label><input type="checkbox" id="fail"> ‡πÑ‡∏°‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢</label>
    <span id="incompleteReason" class="line5"></span><br><br>
    ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: <span id="note" class="line9"></span>
  </div>

  <div class="signature">
    <div>
      <br><br><br>(..........................................)<br><br><br>
      ‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö‡∏á‡∏≤‡∏ô
    </div>
    <div>
      <br><br><br>(..........................................)<br><br><br>
      ‡∏ú‡∏π‡πâ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ / ‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£
    </div>
  </div>
  <div class="signature">
      <u>‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç!</u> ‡∏Å‡∏≤‡∏£‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£<br>
           &nbsp;1. ‡∏™‡πà‡∏á‡∏°‡∏≠‡∏ö‡∏á‡∏≤‡∏ô ‡πÅ‡∏•‡∏∞‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 7 ‡∏ß‡∏±‡∏ô ‡∏ó‡∏≥‡∏Å‡∏≤‡∏£<br>
           &nbsp;2. ‡∏ù‡∏∂‡∏Å‡∏≠‡∏ö‡∏£‡∏°‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 5 ‡∏ß‡∏±‡∏ô ‡∏ó‡∏≥‡∏Å‡∏≤‡∏£<br>
           &nbsp;3. ‡∏≠‡∏≠‡∏Å‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 10 ‡∏ß‡∏±‡∏ô ‡∏ó‡∏≥‡∏Å‡∏≤‡∏£<br>
           &nbsp;4. ‡∏ï‡∏£‡∏ß‡∏à‡πÄ‡∏ä‡πá‡∏Ñ/‡∏ã‡πà‡∏≠‡∏° ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 3 ‡∏ß‡∏±‡∏ô‡∏ó‡∏≥‡∏Å‡∏≤‡∏£<br>
           &nbsp;5. Visit ‡∏á‡∏≤‡∏ô ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 5 ‡∏ß‡∏±‡∏ô ‡∏ó‡∏≥‡∏Å‡∏≤‡∏£<br>
      <div>
        ‡∏Å‡∏£‡∏ì‡∏µ‡∏î‡πà‡∏ß‡∏ô!<br><br><br><br>
        (..........................................)<br>
        ‡∏ú‡∏π‡πâ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥/‡∏Ñ‡∏∏‡∏ì‡∏â‡∏±‡∏ï‡∏£‡∏ä‡∏±‡∏¢
      </div>
    </div>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
import { getDatabase, ref, query, orderByChild, equalTo, get } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-database.js";

// Firebase Config
const firebaseConfig = {
  apiKey: "AIzaSyABY8jkjB2RD3RPK-qQ6kJThm32Pc9OpKE",
  authDomain: "events-93cb9.firebaseapp.com",
  databaseURL: "https://events-93cb9-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "events-93cb9",
  storageBucket: "events-93cb9.firebasestorage.app",
  messagingSenderId: "234410411694",
  appId: "1:234410411694:web:b544058bce0dfe78a88f3f",
  measurementId: "G-4D3X216R1K"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

// ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏ô‡∏µ‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡πâ‡∏ß‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á
let isDataLoaded = false;

// ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å URL parameters ‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡∏°‡∏≤‡∏à‡∏≤‡∏Å manageS.html
function getParamsFromURL() {
  const urlParams = new URLSearchParams(window.location.search);
  return {
    jobNumber: urlParams.get('job'),
    start: urlParams.get('start'),
    end: urlParams.get('end'),
    userPosition: urlParams.get('position')
  };
}

// ‚úÖ ‚úÖ ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô setupBackButton ‡πÉ‡∏´‡πâ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
function setupBackButton() {
  const backBtn = document.getElementById("backBtn");
  
  if (!backBtn) {
    console.error("‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏õ‡∏∏‡πà‡∏° backBtn");
    return;
  }
  
  // ‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: URL parameter > localStorage
  const params = getParamsFromURL();
  let userPosition = null;
  
  // ‚úÖ ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤ URL ‡∏°‡∏µ position ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà (‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏õ‡∏•‡πà‡∏≤)
  if (params.userPosition && params.userPosition.trim() !== "") {
    // ‡∏ñ‡πâ‡∏≤ URL ‡∏°‡∏µ position ‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏á ‚Üí ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á localStorage
    localStorage.setItem("userPosition", params.userPosition);
    userPosition = params.userPosition;
    console.log("‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å position ‡∏à‡∏≤‡∏Å URL:", params.userPosition);
  } else if (params.userPosition === "") {
    // ‚úÖ ‡∏ñ‡πâ‡∏≤ URL ‡∏™‡πà‡∏á position=""  ‚Üí ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå localStorage
    localStorage.removeItem("userPosition");
    console.log("üóëÔ∏è ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå position ‡∏à‡∏≤‡∏Å localStorage (URL ‡∏™‡πà‡∏á‡∏Ñ‡πà‡∏≤‡∏ß‡πà‡∏≤‡∏á)");
  } else {
    // ‡∏ñ‡πâ‡∏≤ URL ‡πÑ‡∏°‡πà‡∏°‡∏µ position ‚Üí ‡πÉ‡∏ä‡πâ‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å localStorage
    userPosition = localStorage.getItem("userPosition");
    console.log("üì¶ ‡πÉ‡∏ä‡πâ position ‡∏à‡∏≤‡∏Å localStorage:", userPosition);
  }
  
  console.log("üîç User Position:", userPosition);
  console.log("üîç URL Position:", params.userPosition);
  console.log("üîç LocalStorage Position:", localStorage.getItem("userPosition"));
  
  // ‚úÖ ‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡πÅ‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏ô‡πÉ‡∏à‡∏ï‡∏±‡∏ß‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏•‡πá‡∏Å-‡πÉ‡∏´‡∏ç‡πà‡πÅ‡∏•‡∏∞‡∏ï‡∏±‡∏î whitespace
  const normalizedPosition = userPosition ? userPosition.trim().toLowerCase() : '';
  
  if (normalizedPosition === "sales") {
    backBtn.addEventListener('click', function() {
      console.log("‚û°Ô∏è ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤: notchoose.html (Sales)");
      window.location.href = 'notchoose.html';
    });
    console.log("‚úÖ ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤: notchoose.html (Sales)");
  } else {
    backBtn.addEventListener('click', function() {
      console.log("‚û°Ô∏è ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤: adminV2.html (Admin/Other)");
      window.location.href = 'adminV2.html';
    });
    console.log("‚úÖ ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤: adminV2.html (Admin/Other)");
  }
}

// ‚úÖ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô Decode ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏´‡∏±‡∏™ (‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö double encoding)
function decodeData(encodedText) {
  if (!encodedText) return "";
  
  try {
    // ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 1: ‡∏•‡∏≠‡∏á decode ‡∏à‡∏≤‡∏Å Base64 ‡∏Å‡πà‡∏≠‡∏ô
    let decoded = decodeURIComponent(escape(atob(encodedText)));
    
    // ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 2: ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏¢‡∏±‡∏á‡πÄ‡∏õ‡πá‡∏ô URL encoded ‡∏≠‡∏¢‡∏π‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
    if (decoded.includes('%')) {
      decoded = decodeURIComponent(decoded);
    }
    
    return decoded;
  } catch (error) {
    // ‡∏ñ‡πâ‡∏≤ decode ‡∏à‡∏≤‡∏Å Base64 ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ ‡∏•‡∏≠‡∏á‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô URL encoded ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
    try {
      if (encodedText.includes('%')) {
        return decodeURIComponent(encodedText);
      }
    } catch (e) {
      console.error("‚ö†Ô∏è Error decoding:", e);
    }
    
    // ‡∏ñ‡πâ‡∏≤‡∏ó‡∏∏‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ
    return encodedText;
  }
}

const jobNumberInput = document.getElementById("jobNumberInput");
const searchBtn = document.getElementById("searchBtn");

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÅ‡∏•‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
async function searchAndDisplay(jobNum = null) {
  const jobNumber = jobNum || jobNumberInput.value.trim();
  
  if (!jobNumber) {
    alert("‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å Job Number");
    return;
  }

  try {
    // Query Realtime Database
    const eventsRef = ref(db, 'events');
    const q = query(eventsRef, orderByChild('jobNumber'), equalTo(jobNumber));
    const snapshot = await get(q);

    if (!snapshot.exists()) {
      alert("‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Job Number: " + jobNumber);
      isDataLoaded = false; // ‚úÖ ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô false ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
      return;
    }

    // Get first matching record
    let data = null;
    snapshot.forEach((childSnapshot) => {
      if (!data) {
        data = childSnapshot.val();
      }
    });

    if (!data) {
      alert("‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Job Number: " + jobNumber);
      isDataLoaded = false; // ‚úÖ ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô false ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
      return;
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô ‡∏û.‡∏®. (‡∏ß/‡∏î/‡∏õ)
    function formatDateThai(dateStr) {
      if (!dateStr) return "";
      const date = new Date(dateStr);
      const day = date.getDate();
      const month = date.getMonth() + 1;
      const year = date.getFullYear() + 543; // ‡πÅ‡∏õ‡∏•‡∏á ‡∏Ñ.‡∏®. ‡πÄ‡∏õ‡πá‡∏ô ‡∏û.‡∏®.
      return `${day}/${month}/${year}`;
    }

    // ‡πÅ‡∏õ‡∏•‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡πà‡∏≠‡∏ô
    const formattedStart = formatDateThai(data.start);
    const formattedOrderDate = formatDateThai(data.orderDate);
    const formattedEnd = formatDateThai(data.end);

    // ‡πÉ‡∏™‡πà‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ü‡∏≠‡∏£‡πå‡∏°
    document.getElementById("docNo").textContent = data.jobNumber || "";
    document.getElementById("jobNo").textContent = data.job || "";
    document.getElementById("assignedBy").textContent = (data.assigners || []).join(", ");
    document.getElementById("date").textContent = formattedStart;
    document.getElementById("orderDate").textContent = formattedOrderDate;
    document.getElementById("deadline").textContent = formattedEnd;
    document.getElementById("deadlines").textContent = formattedEnd;
    
    // ‡πÅ‡∏ö‡πà‡∏á‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏õ‡πá‡∏ô 2 ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î
    const detailsText = data.details || "";
    const maxLength = 100; // ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏ß‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î‡∏ï‡πà‡∏≠‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î
    if (detailsText.length > maxLength) {
      document.getElementById("details").textContent = detailsText.substring(0, maxLength);
      document.getElementById("details2").textContent = detailsText.substring(maxLength);
    } else {
      document.getElementById("details").textContent = detailsText;
      document.getElementById("details2").textContent = "";
    }
    
    document.getElementById("location").textContent = data.location || "";
    document.getElementById("title").textContent = (data.workers || []).join(", ");
    
    // ‚úÖ ‡∏ñ‡∏≠‡∏î‡∏£‡∏´‡∏±‡∏™‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡πÅ‡∏•‡∏∞‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå
    document.getElementById("contactName").textContent = decodeData(data.contactPerson) || "-";
    document.getElementById("contactPhone").textContent = decodeData(data.phoneNumber) || "-";

    // Reset checkboxes
    ["type1","type2","type3","type4","type5"].forEach(id => document.getElementById(id).checked=false);

    // ‡πÄ‡∏ä‡πá‡∏Ñ jobTypes
    if (data.jobTypes) {
      if (data.jobTypes.includes("‡∏™‡πà‡∏á‡∏°‡∏≠‡∏ö")) document.getElementById("type1").checked = true;
      if (data.jobTypes.includes("‡∏ù‡∏∂‡∏Å‡∏≠‡∏ö‡∏£‡∏°")) document.getElementById("type2").checked = true;
      if (data.jobTypes.includes("‡∏ï‡∏£‡∏ß‡∏à‡πÄ‡∏ä‡πá‡∏Ñ/‡∏ã‡πà‡∏≠‡∏°")) document.getElementById("type3").checked = true;
      if (data.jobTypes.includes("Visit")) document.getElementById("type4").checked = true;

      const other = data.jobTypes.find(t =>
        !["‡∏™‡πà‡∏á‡∏°‡∏≠‡∏ö","‡∏ù‡∏∂‡∏Å‡∏≠‡∏ö‡∏£‡∏°","‡∏ï‡∏£‡∏ß‡∏à‡πÄ‡∏ä‡πá‡∏Ñ/‡∏ã‡πà‡∏≠‡∏°","Visit"].includes(t)
      );
      if (other) document.getElementById("type5").checked = true;
    }

    document.getElementById("success").checked = data.status === "‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢";
    document.getElementById("fail").checked = data.status === "‡πÑ‡∏°‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢";
    document.getElementById("note").textContent = data.remark || "";
    document.getElementById("incompleteReason").textContent = data.incompleteReason || "";

    // ‚úÖ ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô true ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
    isDataLoaded = true;
    
    alert("‚úÖ ‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Job Number: " + jobNumber);

  } catch (error) {
    console.error("Error:", error);
    alert("‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + error.message);
    isDataLoaded = false; // ‚úÖ ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô false ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î
  }
}

// Event Listeners
searchBtn.addEventListener("click", () => searchAndDisplay());
jobNumberInput.addEventListener("keypress", (e) => {
  if (e.key === "Enter") searchAndDisplay();
});

// ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏ñ‡πâ‡∏≤‡∏°‡∏µ jobNumber ‡πÉ‡∏ô URL
window.addEventListener('DOMContentLoaded', () => {
  // ‚úÖ ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô setupBackButton ‡∏Å‡πà‡∏≠‡∏ô
  setupBackButton();
  
  const params = getParamsFromURL();
  
  if (params.jobNumber) {
    jobNumberInput.value = params.jobNumber;
    
    if (params.start) console.log("‡∏ß‡∏±‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°:", params.start);
    if (params.end) console.log("‡∏ß‡∏±‡∏ô‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î:", params.end);
    
    searchAndDisplay(params.jobNumber);
  }
});

document.getElementById("printBtn").addEventListener("click", async () => {
  console.log("üîç ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡πà‡∏≠‡∏ô‡∏õ‡∏£‡∏¥‡πâ‡∏ô...");
  
  if (!isDataLoaded) {
    alert("‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡πà‡∏≠‡∏ô‡∏õ‡∏£‡∏¥‡πâ‡∏ô!");
    return;
  }

  const jobNumber = document.getElementById("docNo").textContent.trim();
  if (!jobNumber) {
    alert("‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ü‡∏≠‡∏£‡πå‡∏° ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÉ‡∏´‡∏°‡πà!");
    isDataLoaded = false;
    return;
  }

  const printBtn = document.getElementById("printBtn");
  const originalText = printBtn.textContent;
  printBtn.textContent = "‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á PDF...";
  printBtn.disabled = true;

  try {
    console.log("üìÑ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡∏£‡πâ‡∏≤‡∏á PDF...");
    const element = document.getElementById("report");
    const filename = `${jobNumber}.pdf`;

    console.log("‚è≥ ‡∏£‡∏≠ DOM ‡πÄ‡∏£‡∏ô‡πÄ‡∏î‡∏≠‡∏£‡πå...");
    await new Promise(resolve => setTimeout(resolve, 1000));

    console.log("üé® ‡∏Å‡∏≥‡∏•‡∏±‡∏á render HTML to Canvas...");

    await html2pdf().set({
      margin: 0,
      filename: filename,
      image: { type: "jpeg", quality: 0.98 },
      html2canvas: { 
        scale: 2.5,
        useCORS: true,
        allowTaint: true,
        logging: false,
        letterRendering: true,
        windowHeight: 297 * 3.7795275591,
        height: 297 * 3.7795275591,
        backgroundColor: '#ffffff',
        removeContainer: true,
        imageTimeout: 15000
      },
      jsPDF: { 
        unit: "mm", 
        format: "a4", 
        orientation: "portrait",
        compress: true
      },
      pagebreak: { mode: 'avoid-all' }
    }).from(element).save();

    console.log("‚úÖ PDF ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!");
    alert("‚úÖ ‡∏™‡∏£‡πâ‡∏≤‡∏á PDF ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + filename);

  } catch (error) {
    console.error("‚ùå PDF Error:", error);
    alert("‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + error.message);
  } finally {
    printBtn.textContent = originalText;
    printBtn.disabled = false;
  }
});

// ‚úÖ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô Clear localStorage
function clearLocalStorage() {
  if (confirm("‚ö†Ô∏è ‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• localStorage ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?\n\n(‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• userPosition ‡πÅ‡∏•‡∏∞‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏•‡∏ö)")) {
    localStorage.clear();
    alert("‚úÖ ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• localStorage ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß!");
    console.log("üóëÔ∏è localStorage ‡∏ñ‡∏π‡∏Å‡∏•‡πâ‡∏≤‡∏á‡πÅ‡∏•‡πâ‡∏ß");
  }
}
</script>
</body>
</html>